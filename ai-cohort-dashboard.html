<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŒ»ç™‚ç­‰æƒ…å ±æ´»ç”¨åŸºç›¤ â€” AIåˆ†æã‚¢ã‚·ã‚¹ãƒˆ &amp; ã‚³ãƒ›ãƒ¼ãƒˆå‚ç…§</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', system-ui, sans-serif; background: #F1F5F9; }
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
    @keyframes slideUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    @keyframes countIn { from { opacity:0; transform:scale(0.92); } to { opacity:1; transform:scale(1); } }
    @keyframes bounce { 0%,80%,100%{transform:scale(0.7);opacity:0.4;} 40%{transform:scale(1.1);opacity:1;} }
    @keyframes spin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
    .slide-up { animation: slideUp 0.25s cubic-bezier(0.22,1,0.36,1); }
    .count-in { animation: countIn 0.45s cubic-bezier(0.22,1,0.36,1); }
    .typing-dot { width:7px;height:7px;border-radius:50%;background:#93C5FD;animation:bounce 1.2s infinite; }
    .typing-dot:nth-child(2){animation-delay:0.18s;}
    .typing-dot:nth-child(3){animation-delay:0.36s;}
    .card { background:white; border:1px solid #E2E8F0; border-radius:14px; box-shadow:0 1px 3px rgba(0,0,0,0.05),0 1px 2px rgba(0,0,0,0.03); }
    .btn-run { background:linear-gradient(135deg,#1D4ED8,#2563EB); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer; font-family:inherit; transition:all 0.18s; box-shadow:0 3px 12px rgba(29,78,216,0.35),inset 0 1px 0 rgba(255,255,255,0.12); }
    .btn-run:hover { background:linear-gradient(135deg,#1E40AF,#1D4ED8); transform:translateY(-1px); box-shadow:0 6px 20px rgba(29,78,216,0.45); }
    .btn-run:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
    .btn-ghost { background:white; border:1px solid #E2E8F0; border-radius:9px; color:#475569; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.15s; }
    .btn-ghost:hover { background:#F8FAFC; border-color:#CBD5E1; }
    input:focus, textarea:focus, select:focus { outline:none; border-color:#3B82F6 !important; box-shadow:0 0 0 3px rgba(59,130,246,0.12); }
    .tag { display:inline-flex;align-items:center;gap:4px;padding:4px 10px 4px 12px;border-radius:999px;font-size:12px;font-weight:600; }
    .tag-disease { background:rgba(29,78,216,0.08);color:#1E3A8A;border:1px solid rgba(29,78,216,0.18); }
    .tag-drug { background:rgba(234,88,12,0.08);color:#7C2D12;border:1px solid rgba(234,88,12,0.18); }
    .sug-item:hover { background:#EFF6FF; }
    pre { font-family:'Consolas','Courier New',monospace; font-size:10.5px; line-height:1.72; }
    .funnel-bar { transition:width 0.7s cubic-bezier(0.22,1,0.36,1); }
    input[type=range] { accent-color:#1D4ED8; height:4px; cursor:pointer; }
    input[type=checkbox] { accent-color:#1D4ED8; cursor:pointer; }
    .label-sm { font-size:10.5px;font-weight:700;color:#64748B;text-transform:uppercase;letter-spacing:0.06em; }
    .chat-bubble-user { background:linear-gradient(135deg,#1D4ED8,#2563EB);color:white;border-radius:18px 18px 4px 18px;box-shadow:0 2px 10px rgba(29,78,216,0.28); }
    .chat-bubble-ai { background:white;border:1px solid #E2E8F0;border-radius:18px 18px 18px 4px;box-shadow:0 1px 4px rgba(0,0,0,0.05); }
    .stat-box { border-radius:12px;padding:14px 16px; }
    .db-tmpl-card { border:2px solid #E2E8F0;border-radius:13px;padding:14px;cursor:pointer;background:white;transition:all 0.18s;position:relative; }
    .db-tmpl-card:hover { border-color:#BFDBFE;background:#F8FBFF; }
    .db-tmpl-card.sel-survival { border-color:#1D4ED8;background:#EFF6FF; }
    .db-tmpl-card.sel-ml       { border-color:#7C3AED;background:#F5F3FF; }
    .db-tmpl-card.sel-eda      { border-color:#059669;background:#ECFDF5; }
    .db-tmpl-card.sel-custom   { border-color:#475569;background:#F8FAFC; }
    .db-job-step-done  { background:#1D4ED8;color:white; }
    .db-job-step-idle  { background:#F1F5F9;color:#CBD5E1;border:1px solid #E2E8F0; }
    @keyframes dbSpin  { from{transform:rotate(0deg)}to{transform:rotate(360deg)} }
    .db-spin { display:inline-block;animation:dbSpin 0.9s linear infinite; }
  </style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header style="background:rgba(15,23,42,0.97);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.07);position:sticky;top:0;z-index:50;">
  <div style="max-width:1700px;margin:0 auto;padding:0 20px;height:52px;display:flex;align-items:center;justify-content:space-between;">
    <div style="display:flex;align-items:center;gap:16px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#1D4ED8,#3B82F6);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(29,78,216,0.45);">
          <svg width="18" height="18" fill="white" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-4H7v-2h4V7h2v4h4v2h-4v4h-2z"/></svg>
        </div>
        <div>
          <div style="color:rgba(255,255,255,0.95);font-weight:700;font-size:13.5px;line-height:1.2;letter-spacing:-0.01em;">åŒ»ç™‚ç­‰æƒ…å ±æ´»ç”¨åŸºç›¤ãƒãƒ¼ã‚¿ãƒ«</div>
          <div style="color:rgba(148,163,184,0.65);font-size:9.5px;line-height:1.2;">åšç”ŸåŠ´åƒçœ åŒ»ç™‚ç­‰æƒ…å ±ã®äºŒæ¬¡åˆ©ç”¨</div>
        </div>
      </div>
      <div style="width:1px;height:24px;background:rgba(255,255,255,0.08);"></div>
      <div style="display:flex;gap:6px;align-items:center;">
        <span style="font-size:10px;color:rgba(148,163,184,0.60);">æ¥ç¶šä¸­:</span>
        <span style="padding:2px 8px;background:rgba(29,78,216,0.20);border:1px solid rgba(29,78,216,0.35);border-radius:5px;font-size:9.5px;color:#93C5FD;font-weight:600;">NDB</span>
        <span style="padding:2px 8px;background:rgba(5,150,105,0.18);border:1px solid rgba(5,150,105,0.30);border-radius:5px;font-size:9.5px;color:#6EE7B7;font-weight:600;">ä»‹è­·DB</span>
        <span style="padding:2px 8px;background:rgba(124,58,237,0.18);border:1px solid rgba(124,58,237,0.30);border-radius:5px;font-size:9.5px;color:#C4B5FD;font-weight:600;">DPC</span>
        <span style="padding:2px 8px;background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.28);border-radius:5px;font-size:9.5px;color:#FCD34D;font-weight:600;">é›»å­ã‚«ãƒ«ãƒ†(è©¦)</span>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:14px;">
      <div style="display:flex;align-items:center;gap:6px;font-size:11px;color:rgba(100,116,139,0.75);">
        <span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#4ADE80;box-shadow:0 0 6px rgba(74,222,128,0.6);"></span>
        ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸ç¨¼åƒä¸­
      </div>
      <div style="display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10);border-radius:999px;padding:4px 14px 4px 5px;cursor:pointer;">
        <div style="width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,#F97316,#FBBF24);display:flex;align-items:center;justify-content:center;font-size:13px;">ğŸ‘¤</div>
        <div>
          <div style="color:rgba(255,255,255,0.90);font-size:12px;font-weight:600;">ç”°ä¸­ ä¿å¥å¸«</div>
          <div style="color:rgba(148,163,184,0.55);font-size:9.5px;">ä¿å¥äº‹æ¥­æ‹…å½“</div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- ===== SUB NAV ===== -->
<div style="background:rgba(22,31,48,0.96);border-bottom:1px solid rgba(255,255,255,0.06);padding:0 20px;">
  <div style="max-width:1700px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:38px;">
    <div style="display:flex;align-items:center;gap:6px;font-size:11px;">
      <span style="color:rgba(148,163,184,0.55);">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</span>
      <span style="color:#93C5FD;font-weight:700;background:rgba(29,78,216,0.18);border:1px solid rgba(29,78,216,0.28);padding:1px 10px;border-radius:999px;">é«˜é½¢è€…ç³–å°¿ç—…ã‚³ãƒ›ãƒ¼ãƒˆç ”ç©¶ 2025</span>
      <span style="color:rgba(255,255,255,0.15);">â€º</span>
      <span style="color:rgba(255,255,255,0.75);font-weight:700;">AIåˆ†æã‚¢ã‚·ã‚¹ãƒˆ ï¼† ã‚³ãƒ›ãƒ¼ãƒˆå‚ç…§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
    </div>
    <div style="display:flex;align-items:center;gap:12px;font-size:10.5px;color:rgba(148,163,184,0.55);">
      <span>ç”³è«‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <strong style="color:#FCD34D;">å€«ç†å¯©æŸ»ä¸­</strong></span>
      <span style="color:rgba(255,255,255,0.10);">|</span>
      <span>ãƒ‡ãƒ¼ã‚¿æœ€çµ‚æ›´æ–°: 2026å¹´1æœˆ31æ—¥</span>
    </div>
  </div>
</div>

<!-- ===== MAIN 3-PANE GRID ===== -->
<div style="max-width:1700px;margin:0 auto;padding:14px 16px;display:grid;grid-template-columns:288px 1fr 360px;gap:14px;min-height:calc(100vh - 90px);">

  <!-- ============================================================
       LEFT PANE: CONDITION SPEC
       ============================================================ -->
  <aside style="display:flex;flex-direction:column;gap:12px;">

    <!-- Pane header -->
    <div class="card" style="padding:14px 16px;">
      <div style="display:flex;align-items:center;gap:9px;margin-bottom:2px;">
        <div style="width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#1D4ED8,#3B82F6);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <svg width="14" height="14" fill="white" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        </div>
        <div>
          <div style="font-size:13px;font-weight:700;color:#0F172A;">æ¡ä»¶è¨­å®šï¼ˆãƒ•ã‚£ãƒ¼ã‚¸ãƒ“ãƒªãƒ†ã‚£èª¿æŸ»ï¼‰</div>
          <div style="font-size:10.5px;color:#94A3B8;">åŒ»ç™‚ã‚³ãƒ¼ãƒ‰ä¸è¦ãƒ»æ—¥æœ¬èªã§æ¤œç´¢ã§ãã¾ã™</div>
        </div>
      </div>
    </div>

    <!-- Disease/Drug search -->
    <div class="card" style="padding:16px;">
      <div class="label-sm" style="margin-bottom:10px;">ç–¾æ‚£ãƒ»è–¬å‰¤ã‚’è¿½åŠ </div>
      <div style="position:relative;margin-bottom:10px;">
        <svg style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#94A3B8;" width="13" height="13" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        <input id="condInput" type="text" placeholder="ä¾‹: ç³–å°¿ç—…ã€é«˜è¡€åœ§ã€ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³â€¦"
          style="width:100%;padding:8px 10px 8px 30px;font-size:12px;border:1.5px solid #E2E8F0;border-radius:9px;background:#F8FAFC;color:#0F172A;font-family:inherit;"
          oninput="handleInput(this.value)" onfocus="showSug()" onblur="setTimeout(hideSug,160)">
        <div id="sugBox" style="display:none;position:absolute;top:calc(100%+6px);left:0;right:0;background:white;border:1px solid #E2E8F0;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.10);z-index:100;overflow:hidden;"></div>
      </div>

      <!-- Selected tags -->
      <div id="tagsBox" style="min-height:42px;padding:8px;background:#F8FAFC;border-radius:9px;border:1.5px dashed #CBD5E1;display:flex;flex-wrap:wrap;gap:5px;"></div>

      <!-- AND/OR -->
      <div style="display:flex;align-items:center;gap:7px;margin-top:10px;font-size:11px;">
        <span style="color:#64748B;font-weight:600;">çµã‚Šè¾¼ã¿æ–¹æ³•:</span>
        <button id="btnAnd" onclick="setLogic('AND')" style="padding:4px 12px;border-radius:7px;font-size:11px;font-weight:700;background:#1D4ED8;color:white;border:1.5px solid #1D4ED8;cursor:pointer;font-family:inherit;transition:all 0.15s;">AND</button>
        <button id="btnOr"  onclick="setLogic('OR')"  style="padding:4px 12px;border-radius:7px;font-size:11px;font-weight:700;background:white;color:#64748B;border:1.5px solid #E2E8F0;cursor:pointer;font-family:inherit;transition:all 0.15s;">OR</button>
      </div>
    </div>

    <!-- Age & Gender -->
    <div class="card" style="padding:16px;">
      <div class="label-sm" style="margin-bottom:10px;">å¹´é½¢ãƒ»æ€§åˆ¥</div>
      <div style="margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:6px;">
          <span style="color:#64748B;">å¹´é½¢ç¯„å›²</span>
          <span id="ageLabel" style="font-weight:700;color:#1D4ED8;">60æ­³ ã€œ 85æ­³</span>
        </div>
        <div style="position:relative;height:5px;background:#E2E8F0;border-radius:3px;margin-bottom:7px;">
          <div id="ageTrack" style="position:absolute;top:0;height:100%;border-radius:3px;background:linear-gradient(to right,#1D4ED8,#60A5FA);left:60%;right:15%;"></div>
        </div>
        <input type="range" id="ageMin" min="0" max="100" value="60" oninput="updateAge()" style="width:100%;margin-bottom:4px;">
        <input type="range" id="ageMax" min="0" max="100" value="85" oninput="updateAge()" style="width:100%;">
        <div style="display:flex;justify-content:space-between;font-size:9.5px;color:#94A3B8;margin-top:3px;">
          <span>0æ­³</span><span>25</span><span>50</span><span>75</span><span>100æ­³</span>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;">
        <button id="gAll"    onclick="setGender('all')"    style="padding:7px 0;font-size:11px;font-weight:700;border-radius:8px;background:#1D4ED8;color:white;border:1.5px solid #1D4ED8;cursor:pointer;font-family:inherit;transition:all 0.15s;">å…¨ä½“</button>
        <button id="gMale"   onclick="setGender('male')"   style="padding:7px 0;font-size:11px;font-weight:700;border-radius:8px;background:white;color:#64748B;border:1.5px solid #E2E8F0;cursor:pointer;font-family:inherit;transition:all 0.15s;">â™‚ ç”·æ€§</button>
        <button id="gFemale" onclick="setGender('female')" style="padding:7px 0;font-size:11px;font-weight:700;border-radius:8px;background:white;color:#64748B;border:1.5px solid #E2E8F0;cursor:pointer;font-family:inherit;transition:all 0.15s;">â™€ å¥³æ€§</button>
      </div>
    </div>

    <!-- Observation period -->
    <div class="card" style="padding:16px;">
      <div class="label-sm" style="margin-bottom:10px;">è¦³å¯ŸæœŸé–“</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <select id="obsStart" onchange="updateN()" style="flex:1;padding:7px 10px;font-size:12px;border:1.5px solid #E2E8F0;border-radius:8px;background:white;color:#0F172A;cursor:pointer;font-family:inherit;">
          <option value="2020">2020å¹´</option><option value="2021">2021å¹´</option><option value="2022" selected>2022å¹´</option>
        </select>
        <span style="font-size:12px;color:#94A3B8;">ã€œ</span>
        <select id="obsEnd" onchange="updateN()" style="flex:1;padding:7px 10px;font-size:12px;border:1.5px solid #E2E8F0;border-radius:8px;background:white;color:#0F172A;cursor:pointer;font-family:inherit;">
          <option value="2022">2022å¹´</option><option value="2023">2023å¹´</option><option value="2024" selected>2024å¹´</option>
        </select>
      </div>
    </div>

    <!-- Database -->
    <div class="card" style="padding:16px;">
      <div class="label-sm" style="margin-bottom:10px;">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠ</div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <label style="display:flex;align-items:flex-start;gap:9px;cursor:pointer;">
          <input type="checkbox" checked onchange="updateN()" style="margin-top:2px;width:14px;height:14px;flex-shrink:0;">
          <div>
            <div style="font-size:12.5px;font-weight:600;color:#0F172A;">NDBï¼ˆåŒ»ç™‚ãƒ¬ã‚»ãƒ—ãƒˆãƒ»ç‰¹å®šå¥è¨ºï¼‰</div>
            <div style="font-size:10.5px;color:#94A3B8;">å…¨å›½åŒ»ç§‘ãƒ»èª¿å‰¤ãƒ¬ã‚»ãƒ—ãƒˆ</div>
          </div>
        </label>
        <label style="display:flex;align-items:flex-start;gap:9px;cursor:pointer;">
          <input type="checkbox" checked onchange="updateN()" style="margin-top:2px;width:14px;height:14px;flex-shrink:0;">
          <div>
            <div style="font-size:12.5px;font-weight:600;color:#0F172A;">ä»‹è­·ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</div>
            <div style="font-size:10.5px;color:#94A3B8;">ä»‹è­·ãƒ¬ã‚»ãƒ—ãƒˆãƒ»èªå®šæƒ…å ±</div>
          </div>
        </label>
        <label style="display:flex;align-items:flex-start;gap:9px;cursor:pointer;">
          <input type="checkbox" onchange="updateN()" style="margin-top:2px;width:14px;height:14px;flex-shrink:0;">
          <div>
            <div style="font-size:12.5px;font-weight:600;color:#0F172A;">DPCãƒ‡ãƒ¼ã‚¿</div>
            <div style="font-size:10.5px;color:#94A3B8;">æ€¥æ€§æœŸç—…é™¢ï¼ˆå…¥é™¢ï¼‰ãƒ‡ãƒ¼ã‚¿</div>
          </div>
        </label>
        <label style="display:flex;align-items:flex-start;gap:9px;cursor:pointer;">
          <input type="checkbox" onchange="updateN()" style="margin-top:2px;width:14px;height:14px;flex-shrink:0;">
          <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
            <div style="font-size:12.5px;font-weight:600;color:#0F172A;">é›»å­ã‚«ãƒ«ãƒ†</div>
            <span style="font-size:9px;background:rgba(245,158,11,0.12);color:#B45309;padding:1px 6px;border-radius:4px;font-weight:700;border:1px solid rgba(245,158,11,0.22);">Beta</span>
            <div style="font-size:10.5px;color:#94A3B8;width:100%;">å®Ÿè¨¼äº‹æ¥­å‚åŠ åŒ»ç™‚æ©Ÿé–¢ã®ã¿</div>
          </div>
        </label>
      </div>
    </div>

    <!-- Run button -->
    <button class="btn-run" onclick="runFeasibility(this)" style="padding:13px;font-size:13.5px;display:flex;align-items:center;justify-content:center;gap:8px;">
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      ãƒ•ã‚£ãƒ¼ã‚¸ãƒ“ãƒªãƒ†ã‚£èª¿æŸ»ã‚’å®Ÿè¡Œ
    </button>

    <!-- Privacy notice -->
    <div style="background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.22);border-radius:10px;padding:10px 13px;font-size:10.5px;color:#78350F;">
      ğŸ”’ <strong>å€‹äººæƒ…å ±ä¿è­·æªç½®ï¼š</strong> n &lt; 10 ã¯ã€Œï¼Šã€éè¡¨ç¤ºã€‚å¹´é½¢ãƒ»æ€§åˆ¥ãƒ»åœ°åŸŸã®çµ„åˆã›ã«ã‚ˆã‚‹å€‹äººç‰¹å®šãƒªã‚¹ã‚¯é›†è¨ˆã¯è‡ªå‹•æŠ‘åˆ¶ã€‚
    </div>
  </aside>

  <!-- ============================================================
       CENTER PANE: DASHBOARD
       ============================================================ -->
  <main style="display:flex;flex-direction:column;gap:14px;min-width:0;">

    <!-- N-count banner -->
    <div style="border-radius:16px;overflow:hidden;position:relative;background:linear-gradient(135deg,#0F2044 0%,#1D4ED8 60%,#2563EB 100%);padding:22px 26px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 24px rgba(29,78,216,0.30);">
      <div style="position:absolute;right:0;top:0;bottom:0;width:240px;background:radial-gradient(ellipse at 60% 50%,rgba(96,165,250,0.18) 0%,transparent 70%);pointer-events:none;"></div>
      <div style="position:relative;">
        <div style="font-size:10px;color:rgba(147,197,253,0.80);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:5px;">æ¨å®šå¯¾è±¡æ‚£è€…æ•°ï¼ˆNDB 2022â€“2024å¹´ï¼‰</div>
        <div id="nDisplay" style="display:flex;align-items:baseline;gap:8px;" class="count-in">
          <span style="font-size:24px;font-weight:700;color:rgba(148,163,184,0.85);">ç´„</span>
          <span id="nVal" style="font-size:52px;font-weight:900;color:white;letter-spacing:-0.04em;text-shadow:0 2px 24px rgba(255,255,255,0.25);">12,450</span>
          <span style="font-size:22px;font-weight:700;color:rgba(147,197,253,0.85);">äºº</span>
        </div>
        <div style="font-size:10px;color:rgba(147,197,253,0.65);margin-top:4px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <span>â€» n &lt; 10 ã®å ´åˆã¯ã€Œï¼Šã€ã§éè¡¨ç¤ºï¼ˆå€‹äººç‰¹å®šé˜²æ­¢ï¼‰</span>
          <span style="background:rgba(29,78,216,0.40);border:1px solid rgba(147,197,253,0.25);padding:1px 9px;border-radius:5px;color:rgba(191,219,254,0.90);">æ¨å®šç²¾åº¦ Â±5%ï¼ˆ95%CIï¼‰</span>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:7px;align-items:flex-end;position:relative;flex-shrink:0;">
        <div style="background:rgba(255,255,255,0.09);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:9px 16px;text-align:right;backdrop-filter:blur(8px);">
          <div style="font-size:9.5px;color:rgba(147,197,253,0.70);text-transform:uppercase;letter-spacing:0.06em;">ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ—¥</div>
          <div style="font-size:13px;font-weight:600;color:white;margin-top:2px;">2026å¹´1æœˆ31æ—¥</div>
        </div>
        <div style="background:rgba(5,150,105,0.18);border:1px solid rgba(16,185,129,0.30);border-radius:10px;padding:9px 16px;text-align:right;">
          <div style="font-size:9.5px;color:rgba(110,231,183,0.75);text-transform:uppercase;letter-spacing:0.06em;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·</div>
          <div style="font-size:12px;font-weight:700;color:#6EE7B7;margin-top:2px;">âœ“ æ­£å¸¸ç¨¼åƒ</div>
        </div>
      </div>
    </div>

    <!-- Funnel chart -->
    <div class="card" style="padding:18px 22px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div>
          <div style="font-size:13px;font-weight:700;color:#0F172A;">çµã‚Šè¾¼ã¿ãƒ•ãƒ­ãƒ¼ï¼ˆãƒ‡ãƒ¼ã‚¿ä»¶æ•°ã®æ¸›è¡°ï¼‰</div>
          <div style="font-size:10.5px;color:#94A3B8;margin-top:2px;">å„ã‚¹ãƒ†ãƒƒãƒ—ã§é©ç”¨ã—ãŸæ¡ä»¶ã¨æ®‹å­˜ä»¶æ•°</div>
        </div>
        <span style="font-size:10px;color:#2563EB;background:#EFF6FF;border:1px solid #DBEAFE;padding:3px 9px;border-radius:6px;font-weight:600;">â–² æ¡ä»¶å¤‰æ›´ã§è‡ªå‹•æ›´æ–°</span>
      </div>
      <div id="funnelWrap" style="display:flex;flex-direction:column;gap:7px;"></div>
    </div>

    <!-- Chart area -->
    <div class="card" style="padding:18px 22px;flex:1;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div>
          <div id="chartTitle" style="font-size:13px;font-weight:700;color:#0F172A;">åˆ†æçµæœã‚°ãƒ©ãƒ•</div>
          <div id="chartSub" style="font-size:10.5px;color:#94A3B8;margin-top:2px;">AIã«è³ªå•ã™ã‚‹ã¨ã€ã“ã“ã«ã‚°ãƒ©ãƒ•ãŒæç”»ã•ã‚Œã¾ã™</div>
        </div>
        <div id="chartBtns" style="display:none;gap:7px;">
          <button class="btn-ghost" style="font-size:11px;padding:5px 12px;display:flex;align-items:center;gap:5px;">
            <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>CSV
          </button>
          <button class="btn-ghost" style="font-size:11px;padding:5px 12px;display:flex;align-items:center;gap:5px;">
            <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>PNG
          </button>
        </div>
      </div>

      <!-- Placeholder -->
      <div id="chartPlaceholder" style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 20px;color:#94A3B8;">
        <svg width="52" height="52" fill="currentColor" viewBox="0 0 24 24" style="opacity:0.20;margin-bottom:12px;"><path d="M5 9.2h3V19H5V9.2zM10.6 5h2.8v14h-2.8V5zm5.6 5.4H19V19h-2.8v-8.6z"/></svg>
        <div style="font-size:13.5px;font-weight:500;">AIã«åˆ†æã‚’ä¾é ¼ã—ã¦ãã ã•ã„</div>
        <div style="font-size:11px;margin-top:6px;text-align:center;line-height:1.7;">å³ã®ãƒãƒ£ãƒƒãƒˆæ¬„ã‹ã‚‰ã€Œè…¹å›²åŸºæº–è¶…ãˆå‰²åˆã‚’å¹´ä»£åˆ¥ã«ã€ãªã©ã¨å…¥åŠ›ã™ã‚‹ã¨<br>ã‚°ãƒ©ãƒ•ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™</div>
        <div style="display:flex;flex-direction:column;gap:6px;margin-top:16px;width:100%;max-width:280px;">
          <div style="font-size:11px;color:#60A5FA;text-align:center;font-weight:600;margin-bottom:2px;">âœ¨ åˆ©ç”¨ã§ãã‚‹æ©Ÿèƒ½</div>
          <div style="font-size:11px;color:#475569;display:flex;align-items:center;gap:7px;"><span style="color:#059669;font-weight:700;">âœ“</span>SQLè‡ªå‹•ç”Ÿæˆï¼ˆã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚ã‚Šï¼‰</div>
          <div style="font-size:11px;color:#475569;display:flex;align-items:center;gap:7px;"><span style="color:#059669;font-weight:700;">âœ“</span>æ£’ã‚°ãƒ©ãƒ•ãƒ»æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•è‡ªå‹•æç”»</div>
          <div style="font-size:11px;color:#475569;display:flex;align-items:center;gap:7px;"><span style="color:#059669;font-weight:700;">âœ“</span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¿å­˜ãƒ»æŒå‡ºç”³è«‹</div>
        </div>
      </div>

      <canvas id="mainChart" style="display:none;max-height:300px;"></canvas>
      <div id="chartLegend" style="display:none;margin-top:10px;display:none;align-items:center;gap:16px;font-size:11px;color:#475569;flex-wrap:wrap;">
        <div style="display:flex;align-items:center;gap:5px;"><span style="display:inline-block;width:12px;height:12px;border-radius:3px;background:#1D4ED8;"></span>ç”·æ€§</div>
        <div style="display:flex;align-items:center;gap:5px;"><span style="display:inline-block;width:12px;height:12px;border-radius:3px;background:#EC4899;"></span>å¥³æ€§</div>
        <div style="margin-left:auto;font-size:10.5px;color:#94A3B8;">ç‰¹å®šå¥è¨ºãƒ‡ãƒ¼ã‚¿ï¼ˆè…¹å›²åŸºæº–: ç”·æ€§â‰¥85cm / å¥³æ€§â‰¥90cmï¼‰</div>
      </div>
    </div>

    <!-- Stats panel (hidden initially) -->
    <div id="statsPanel" style="display:none;">
      <div class="card" style="padding:18px 22px;">
        <div style="font-size:13px;font-weight:700;color:#0F172A;margin-bottom:12px;">ğŸ“Š çµ±è¨ˆã‚µãƒãƒªãƒ¼</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
          <div class="stat-box" style="background:#EFF6FF;border:1px solid #BFDBFE;">
            <div style="font-size:10.5px;color:#1D4ED8;margin-bottom:4px;">ç·å¯¾è±¡è€…æ•°</div>
            <div style="font-size:22px;font-weight:900;color:#1E3A8A;letter-spacing:-0.02em;">12,450<span style="font-size:12px;font-weight:600;margin-left:2px;">å</span></div>
          </div>
          <div class="stat-box" style="background:#ECFDF5;border:1px solid #A7F3D0;">
            <div style="font-size:10.5px;color:#059669;margin-bottom:4px;">è…¹å›²åŸºæº–è¶…ãˆ</div>
            <div style="font-size:22px;font-weight:900;color:#065F46;letter-spacing:-0.02em;">67.3<span style="font-size:12px;font-weight:600;margin-left:2px;">%</span></div>
          </div>
          <div class="stat-box" style="background:#FFFBEB;border:1px solid #FDE68A;">
            <div style="font-size:10.5px;color:#D97706;margin-bottom:4px;">ä¸­å¤®å€¤å¹´é½¢</div>
            <div style="font-size:22px;font-weight:900;color:#78350F;letter-spacing:-0.02em;">72<span style="font-size:12px;font-weight:600;margin-left:2px;">æ­³</span></div>
          </div>
          <div class="stat-box" style="background:#F5F3FF;border:1px solid #DDD6FE;">
            <div style="font-size:10.5px;color:#7C3AED;margin-bottom:4px;">ç”·æ€§å‰²åˆ</div>
            <div style="font-size:22px;font-weight:900;color:#4C1D95;letter-spacing:-0.02em;">54.2<span style="font-size:12px;font-weight:600;margin-left:2px;">%</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Action buttons (hidden initially) -->
    <div id="actionBtns" style="display:none;flex-direction:column;gap:10px;">
      <div style="display:flex;gap:10px;">
        <button class="btn-ghost" style="flex:1;padding:11px;font-size:12.5px;display:flex;align-items:center;justify-content:center;gap:6px;border-radius:11px;">ğŸ“Œ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ä¿å­˜</button>
        <button class="btn-ghost" style="flex:1;padding:11px;font-size:12.5px;display:flex;align-items:center;justify-content:center;gap:6px;border-radius:11px;">ğŸ“¤ æŒå‡ºç”³è«‹ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰</button>
        <button style="flex:1;padding:11px;font-size:12.5px;font-weight:700;color:white;border:none;border-radius:11px;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:6px;background:linear-gradient(135deg,#059669,#10B981);box-shadow:0 3px 12px rgba(5,150,105,0.30);">ğŸ“„ ç”³è«‹æ›¸ã«åæ˜ ã™ã‚‹</button>
      </div>
      <!-- Databricks launch button -->
      <button onclick="openDBModal()" style="width:100%;padding:14px;font-size:13.5px;font-weight:700;color:white;border:none;border-radius:13px;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:9px;background:linear-gradient(135deg,#1e1b4b 0%,#312e81 40%,#4338ca 100%);box-shadow:0 4px 20px rgba(67,56,202,0.40),inset 0 1px 0 rgba(255,255,255,0.12);transition:all 0.18s;" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 7px 28px rgba(67,56,202,0.52),inset 0 1px 0 rgba(255,255,255,0.12)'" onmouseout="this.style.transform='';this.style.boxShadow='0 4px 20px rgba(67,56,202,0.40),inset 0 1px 0 rgba(255,255,255,0.12)'">
        <svg width="18" height="18" viewBox="0 0 32 32" fill="none" style="flex-shrink:0;">
          <polygon points="16,3 29,10 29,22 16,29 3,22 3,10" fill="none" stroke="rgba(252,100,60,0.95)" stroke-width="2.5"/>
          <polygon points="16,8 24,12.5 24,19.5 16,24 8,19.5 8,12.5" fill="rgba(252,100,60,0.25)" stroke="rgba(252,100,60,0.75)" stroke-width="1.5"/>
        </svg>
        <span>Databricks ã§åˆ†æã‚’é–‹å§‹</span>
        <svg width="14" height="14" fill="rgba(255,255,255,0.65)" viewBox="0 0 24 24" style="margin-left:2px;"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      </button>
    </div>
  </main>

  <!-- ============================================================
       RIGHT PANE: AI CHAT
       ============================================================ -->
  <aside class="card" style="display:flex;flex-direction:column;overflow:hidden;position:sticky;top:68px;height:calc(100vh - 82px);">

    <!-- Chat header -->
    <div style="padding:12px 16px;background:linear-gradient(135deg,#0F2044,#1D4ED8);display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,0.07);flex-shrink:0;">
      <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#F59E0B,#F97316);display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0;box-shadow:0 2px 8px rgba(249,115,22,0.40);">ğŸ¤–</div>
      <div style="flex:1;min-width:0;">
        <div style="color:rgba(255,255,255,0.95);font-size:13.5px;font-weight:700;line-height:1.2;">Genie â€” AIåˆ†æã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</div>
        <div style="color:rgba(147,197,253,0.75);font-size:10px;display:flex;align-items:center;gap:5px;margin-top:2px;">
          <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#4ADE80;box-shadow:0 0 5px rgba(74,222,128,0.60);animation:pulse 2s infinite;"></span>
          Databricks Genie Ã— Claudeæ­è¼‰ Â· NDBæ¥ç¶šä¸­
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div id="chatMsgs" style="flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:12px;background:#F8FAFC;">

      <!-- Welcome -->
      <div style="background:white;border:1px solid #DBEAFE;border-radius:12px;padding:13px;font-size:11.5px;color:#334155;line-height:1.75;">
        <div style="font-weight:700;color:#1D4ED8;margin-bottom:7px;display:flex;align-items:center;gap:5px;">
          <svg width="13" height="13" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
          Genieã¸ã‚ˆã†ã“ã
        </div>
        <p>å·¦ãƒšã‚¤ãƒ³ã§è¨­å®šã—ãŸæ¡ä»¶ã«ã¤ã„ã¦ã€æ—¥æœ¬èªã§è‡ªç”±ã«è³ªå•ãƒ»åˆ†æä¾é ¼ãŒã§ãã¾ã™ã€‚<br>SQLã®çŸ¥è­˜ã¯ä¸è¦ã§ã™ã€‚</p>
        <div style="margin-top:10px;">
          <div style="font-size:10px;color:#94A3B8;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:7px;">ğŸ’¡ è³ªå•ä¾‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›ï¼‰</div>
          <div style="display:flex;flex-direction:column;gap:5px;">
            <button onclick="useEx(0)" style="text-align:left;padding:7px 10px;background:#EFF6FF;border:1px solid #BFDBFE;border-radius:8px;font-size:11px;color:#1D4ED8;cursor:pointer;font-family:inherit;transition:background 0.15s;line-height:1.5;" onmouseover="this.style.background='#DBEAFE'" onmouseout="this.style.background='#EFF6FF'">é¸æŠã—ãŸæ‚£è€…ã®è…¹å›²åŸºæº–è¶…ãˆå‰²åˆã‚’å¹´ä»£åˆ¥ã«ã‚°ãƒ©ãƒ•åŒ–ã—ã¦</button>
            <button onclick="useEx(1)" style="text-align:left;padding:7px 10px;background:#EFF6FF;border:1px solid #BFDBFE;border-radius:8px;font-size:11px;color:#1D4ED8;cursor:pointer;font-family:inherit;transition:background 0.15s;line-height:1.5;" onmouseover="this.style.background='#DBEAFE'" onmouseout="this.style.background='#EFF6FF'">é«˜è¡€åœ§ã®åˆä½µç‡ã®å¹´æ¬¡æ¨ç§»ã‚’æ•™ãˆã¦</button>
            <button onclick="useEx(2)" style="text-align:left;padding:7px 10px;background:#EFF6FF;border:1px solid #BFDBFE;border-radius:8px;font-size:11px;color:#1D4ED8;cursor:pointer;font-family:inherit;transition:background 0.15s;line-height:1.5;" onmouseover="this.style.background='#DBEAFE'" onmouseout="this.style.background='#EFF6FF'">æŠ•è–¬ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æœ€ã‚‚å¤šã„çµ„ã¿åˆã‚ã›Top5ã¯ï¼Ÿ</button>
          </div>
        </div>
      </div>

    </div>

    <!-- Input area -->
    <div style="padding:10px 12px;background:white;border-top:1px solid #F1F5F9;flex-shrink:0;">
      <div style="display:flex;gap:8px;align-items:flex-end;">
        <textarea id="chatIn" rows="2" placeholder="ä¾‹: ç³–å°¿ç—…æ‚£è€…ã®è…¹å›²åŸºæº–è¶…ãˆå‰²åˆã‚’å¹´ä»£åˆ¥ã«ã‚°ãƒ©ãƒ•åŒ–ã—ã¦ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰"
          style="flex:1;padding:9px 12px;font-size:11.5px;border:1.5px solid #E2E8F0;border-radius:10px;background:#F8FAFC;resize:none;color:#0F172A;line-height:1.55;font-family:inherit;"
          onkeydown="chatKey(event)"></textarea>
        <button onclick="sendMsg()" style="width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#1D4ED8,#2563EB);color:white;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 2px 8px rgba(29,78,216,0.35);transition:all 0.15s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          <svg width="15" height="15" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
      <div style="display:flex;gap:8px;margin-top:7px;font-size:10.5px;">
        <button onclick="clearChat()" style="color:#94A3B8;background:none;border:none;cursor:pointer;font-family:inherit;transition:color 0.15s;" onmouseover="this.style.color='#64748B'" onmouseout="this.style.color='#94A3B8'">ğŸ—‘ å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
        <span style="color:#E2E8F0;">|</span>
        <button style="color:#94A3B8;background:none;border:none;cursor:pointer;font-family:inherit;transition:color 0.15s;" onmouseover="this.style.color='#64748B'" onmouseout="this.style.color='#94A3B8'">ğŸ“Œ ã“ã®ä¼šè©±ã‚’ä¿å­˜</button>
      </div>
    </div>
  </aside>

</div><!-- end grid -->

<!-- ===== DATABRICKS MODAL ===== -->
<div id="dbModal" onclick="if(event.target===this)closeDBModal()" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.68);backdrop-filter:blur(6px);z-index:999;align-items:center;justify-content:center;padding:16px;">
  <div onclick="event.stopPropagation()" style="background:white;border-radius:20px;width:min(820px,100%);max-height:93vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 24px 80px rgba(0,0,0,0.45),0 0 0 1px rgba(255,255,255,0.05);" class="slide-up">

    <!-- Modal Header -->
    <div style="background:linear-gradient(135deg,#0F2044 0%,#1e1b4b 40%,#312e81 100%);padding:16px 22px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
      <div style="display:flex;align-items:center;gap:13px;">
        <div style="width:42px;height:42px;border-radius:12px;background:rgba(255,255,255,0.10);border:1.5px solid rgba(255,255,255,0.18);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <svg width="24" height="24" viewBox="0 0 32 32" fill="none">
            <polygon points="16,3 29,10 29,22 16,29 3,22 3,10" fill="none" stroke="rgba(252,100,60,0.95)" stroke-width="2.5"/>
            <polygon points="16,8 24,12.5 24,19.5 16,24 8,19.5 8,12.5" fill="rgba(252,100,60,0.25)" stroke="rgba(252,100,60,0.75)" stroke-width="1.5"/>
          </svg>
        </div>
        <div>
          <div style="color:white;font-weight:700;font-size:15px;letter-spacing:-0.01em;">Databricks åˆ†æã‚¸ãƒ§ãƒ–æŠ•å…¥</div>
          <div style="color:rgba(147,197,253,0.70);font-size:10.5px;margin-top:2px;">ã‚³ãƒ›ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯åˆ†æã‚’é–‹å§‹ã—ã¾ã™</div>
        </div>
      </div>
      <button onclick="closeDBModal()" style="width:34px;height:34px;border-radius:9px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.13);color:rgba(255,255,255,0.65);font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:inherit;transition:background 0.15s;flex-shrink:0;" onmouseover="this.style.background='rgba(255,255,255,0.16)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'">âœ•</button>
    </div>

    <!-- Step Indicator -->
    <div id="dbStepper" style="padding:16px 24px 0;background:white;flex-shrink:0;"></div>

    <!-- Step Content -->
    <div id="dbContent" style="flex:1;overflow-y:auto;padding:20px 24px;"></div>

    <!-- Footer -->
    <div style="padding:13px 22px;border-top:1.5px solid #F1F5F9;background:white;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
      <button id="dbPrevBtn" onclick="dbStepPrev()" style="padding:9px 20px;border-radius:10px;font-size:12.5px;font-weight:600;background:white;border:1.5px solid #E2E8F0;color:#475569;cursor:pointer;font-family:inherit;transition:all 0.15s;" onmouseover="this.style.background='#F8FAFC'" onmouseout="this.style.background='white'">â† æˆ»ã‚‹</button>
      <div style="display:flex;gap:10px;align-items:center;">
        <span id="dbStepLabel" style="font-size:11px;color:#94A3B8;"></span>
        <button onclick="closeDBModal()" style="padding:9px 18px;border-radius:10px;font-size:12.5px;font-weight:600;background:white;border:1.5px solid #E2E8F0;color:#64748B;cursor:pointer;font-family:inherit;transition:all 0.15s;" onmouseover="this.style.background='#F8FAFC'" onmouseout="this.style.background='white'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="dbNextBtn" onclick="dbStepNext()" class="btn-run" style="padding:9px 24px;font-size:12.5px;">æ¬¡ã¸ â†’</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== JAVASCRIPT ===== -->
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUGS = [
  {label:'2å‹ç³–å°¿ç—…',code:'E11',type:'disease'},{label:'1å‹ç³–å°¿ç—…',code:'E10',type:'disease'},
  {label:'é«˜è¡€åœ§ç—‡',code:'I10',type:'disease'},{label:'æ…¢æ€§è…è‡“ç—…(CKD)',code:'N18',type:'disease'},
  {label:'è„‚è³ªç•°å¸¸ç—‡',code:'E78',type:'disease'},{label:'å¿ƒä¸å…¨',code:'I50',type:'disease'},
  {label:'å¿ƒæˆ¿ç´°å‹•',code:'I48',type:'disease'},{label:'ã‚¢ãƒ«ãƒ„ãƒã‚¤ãƒãƒ¼å‹èªçŸ¥ç—‡',code:'G30',type:'disease'},
  {label:'è„³æ¢—å¡',code:'I63',type:'disease'},{label:'éª¨ç²—é¬†ç—‡',code:'M81',type:'disease'},
  {label:'ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³',code:'D01',type:'drug'},{label:'SGLT2é˜»å®³è–¬',code:'D02',type:'drug'},
  {label:'GLP-1å—å®¹ä½“ä½œå‹•è–¬',code:'D03',type:'drug'},{label:'DPP-4é˜»å®³è–¬',code:'D04',type:'drug'},
  {label:'ã‚¤ãƒ³ã‚¹ãƒªãƒ³è£½å‰¤',code:'D05',type:'drug'},{label:'ARB',code:'D06',type:'drug'},
  {label:'ã‚¹ã‚¿ãƒãƒ³',code:'D07',type:'drug'},
];

let selTags = [
  {label:'2å‹ç³–å°¿ç—…',code:'E11',type:'disease'},
  {label:'é«˜è¡€åœ§ç—‡',code:'I10',type:'disease'},
  {label:'ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³',code:'D01',type:'drug'},
];
let logic = 'AND';
let gender = 'all';
let chartInst = null;
let sqlN = 0;

const EXAMPLES = [
  'é¸æŠã—ãŸæ‚£è€…ã®è…¹å›²åŸºæº–è¶…ãˆå‰²åˆã‚’å¹´ä»£åˆ¥ã«ã‚°ãƒ©ãƒ•åŒ–ã—ã¦',
  'é«˜è¡€åœ§ã®åˆä½µç‡ã®å¹´æ¬¡æ¨ç§»ã‚’æ•™ãˆã¦',
  'æŠ•è–¬ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æœ€ã‚‚å¤šã„çµ„ã¿åˆã‚ã›Top5ã¯ï¼Ÿ',
];

const SQL_CODE = `-- AIè‡ªå‹•ç”Ÿæˆã‚¯ã‚¨ãƒªï¼ˆDatabricks SQL / ç·¨é›†å¯èƒ½ï¼‰
SELECT
    age_group,
    gender,
    COUNT(*) AS patient_count,
    SUM(CASE WHEN waist_over = 1 THEN 1 ELSE 0 END) AS waist_over_count,
    ROUND(
        SUM(CASE WHEN waist_over = 1 THEN 1 ELSE 0 END)
        * 100.0 / COUNT(*), 1
    ) AS waist_over_pct
FROM (
    SELECT
        r.patient_id,
        CASE
            WHEN FLOOR(DATEDIFF(r.claim_date, p.birth_date)/365.25) < 40 THEN '30ä»£'
            WHEN FLOOR(DATEDIFF(r.claim_date, p.birth_date)/365.25) < 50 THEN '40ä»£'
            WHEN FLOOR(DATEDIFF(r.claim_date, p.birth_date)/365.25) < 60 THEN '50ä»£'
            WHEN FLOOR(DATEDIFF(r.claim_date, p.birth_date)/365.25) < 70 THEN '60ä»£'
            WHEN FLOOR(DATEDIFF(r.claim_date, p.birth_date)/365.25) < 80 THEN '70ä»£'
            WHEN FLOOR(DATEDIFF(r.claim_date, p.birth_date)/365.25) < 90 THEN '80ä»£'
            ELSE '90ä»£+'
        END AS age_group,
        p.gender,
        CASE
            WHEN p.gender = 'M' AND h.waist_cm >= 85 THEN 1
            WHEN p.gender = 'F' AND h.waist_cm >= 90 THEN 1
            ELSE 0
        END AS waist_over
    FROM ndb.claims_medical r
    INNER JOIN ndb.patient_master p USING (patient_id)
    INNER JOIN ndb.specific_health_checkup h
        ON r.patient_id = h.patient_id
        AND YEAR(r.claim_date) = h.checkup_year
    WHERE
        r.diagnosis_code LIKE 'E11%'  -- 2å‹ç³–å°¿ç—…
        AND YEAR(r.claim_date) BETWEEN 2022 AND 2024
        AND r.claim_type = 'medical'
) t
GROUP BY age_group, gender
ORDER BY age_group, gender;`;

const AI_RESPS = {
  0: {
    text: 'æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚NDBã®åŒ»ç§‘ãƒ¬ã‚»ãƒ—ãƒˆãŠã‚ˆã³ç‰¹å®šå¥è¨ºãƒ‡ãƒ¼ã‚¿ã‹ã‚‰**SQLã‚’è‡ªå‹•ç”Ÿæˆ**ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºãƒ»é›†è¨ˆã—ã¾ã—ãŸã€‚\n\n**ğŸ“Š åˆ†æçµæœã®ãƒã‚¤ãƒ³ãƒˆ:**\nâ€¢ å¯¾è±¡æ‚£è€… **12,450å** ã®è…¹å›²åŸºæº–è¶…ãˆå‰²åˆã¯å…¨ä½“ **67.3%**\nâ€¢ 70ä»£ç”·æ€§ã§æœ€å¤§ **72%** â€”â€”å¹´ä»£ãŒä¸ŠãŒã‚‹ã»ã©å¢—åŠ å‚¾å‘\nâ€¢ å¥³æ€§ã¯ç”·æ€§ã‚ˆã‚Šä½ã„ãŒã€70ä»£ä»¥é™ã¯ **60%** ã‚’è¶…ãˆã¦ã„ã¾ã™\nâ€¢ 30ä»£ç”·æ€§ã§ã‚‚ **28%** ãŒåŸºæº–è¶…ãˆã§ã‚ã‚Šã€è‹¥å¹´å±¤ã¸ã®æ—©æœŸä»‹å…¥ãŒé‡è¦\n\nä¸­å¤®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«å¹´ä»£åˆ¥ã‚°ãƒ©ãƒ•ã‚’æç”»ã—ã¾ã—ãŸã€‚',
    doChart: true,
  },
  1: {
    text: 'é«˜è¡€åœ§åˆä½µç‡ã®å¹´æ¬¡æ¨ç§»ã‚’åˆ†æã—ã¾ã—ãŸã€‚\n\n**ğŸ“ˆ åˆ†æçµæœ:**\nâ€¢ 2022å¹´: **58.4%** â†’ 2023å¹´: **61.2%** â†’ 2024å¹´: **63.7%**\nâ€¢ å¹´é–“ç´„ **+2.5ãƒã‚¤ãƒ³ãƒˆ** ã®ä¸Šæ˜‡å‚¾å‘ãŒç¶šã„ã¦ã„ã¾ã™\nâ€¢ ç‰¹ã« **70ä»£ä»¥ä¸Š** ã§ã®åˆä½µç‡å¢—åŠ ãŒé¡•è‘—ã§ã™\nâ€¢ è…æ©Ÿèƒ½ä½ä¸‹ã‚’ä¼´ã†ç—‡ä¾‹ãŒå¢—åŠ ã—ã¦ãŠã‚Šã€æ²»ç™‚å¼·åŒ–ãŒèª²é¡Œã§ã™',
    doChart: false,
  },
  2: {
    text: 'æŠ•è–¬ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æã—ã¾ã—ãŸï¼ˆIPWæ³•ã§äº¤çµ¡èª¿æ•´æ¸ˆã¿ï¼‰ã€‚\n\n**ğŸ’Š ä¸Šä½5ãƒ‘ã‚¿ãƒ¼ãƒ³:**\n1. **ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³å˜å‰¤**: 34.2%\n2. **ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³ + DPP-4é˜»å®³è–¬**: 28.7%\n3. **ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³ + SGLT2é˜»å®³è–¬**: 18.3%\n4. **ã‚¤ãƒ³ã‚¹ãƒªãƒ³ + ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³**: 10.1%\n5. **GLP-1 + SGLT2é˜»å®³è–¬**: 8.7%\n\nSGLT2é˜»å®³è–¬ã®ä½¿ç”¨ç‡ãŒ2021å¹´æ¯”ã§ **+12.4ãƒã‚¤ãƒ³ãƒˆ** å¢—åŠ ã—ã¦ã„ã¾ã™ã€‚',
    doChart: false,
  },
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  renderTags();
  renderFunnel();
  updateN();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TAGS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleInput(v) {
  const box = document.getElementById('sugBox');
  const filtered = v.length > 0
    ? SUGS.filter(s => s.label.includes(v) && !selTags.find(t => t.code === s.code))
    : SUGS.filter(s => !selTags.find(t => t.code === s.code)).slice(0, 8);
  if (!filtered.length) { box.style.display = 'none'; return; }
  box.innerHTML = filtered.map(s => `
    <div class="sug-item" style="padding:9px 12px;cursor:pointer;display:flex;align-items:center;gap:9px;font-size:12px;transition:background 0.12s;" onmousedown="addTag('${s.code}')">
      <span style="font-size:9.5px;font-weight:700;padding:2px 7px;border-radius:5px;flex-shrink:0;${s.type==='disease'?'background:rgba(29,78,216,0.10);color:#1E3A8A;border:1px solid rgba(29,78,216,0.20);':'background:rgba(234,88,12,0.10);color:#7C2D12;border:1px solid rgba(234,88,12,0.20);'}">
        ${s.type==='disease'?'ICD':'è–¬å“'}
      </span>
      <span style="color:#0F172A;font-weight:500;">${s.label}</span>
      <span style="font-size:10px;color:#94A3B8;margin-left:auto;">${s.code}</span>
    </div>
  `).join('');
  box.style.display = 'block';
}
function showSug() { handleInput(document.getElementById('condInput').value); }
function hideSug() { document.getElementById('sugBox').style.display = 'none'; }

function addTag(code) {
  const s = SUGS.find(x => x.code === code);
  if (!s || selTags.find(t => t.code === code)) return;
  selTags.push(s);
  document.getElementById('condInput').value = '';
  renderTags(); updateN();
}
function removeTag(code) {
  selTags = selTags.filter(t => t.code !== code);
  renderTags(); updateN();
}
function renderTags() {
  const box = document.getElementById('tagsBox');
  if (!selTags.length) {
    box.innerHTML = '<span style="font-size:11.5px;color:#94A3B8;align-self:center;padding:4px 2px;">æ¡ä»¶ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</span>';
    return;
  }
  box.innerHTML = selTags.map(t => `
    <span class="tag ${t.type==='disease'?'tag-disease':'tag-drug'}">
      ${t.label}
      <button onclick="removeTag('${t.code}')" style="background:none;border:none;cursor:pointer;font-size:15px;line-height:1;opacity:0.50;color:inherit;padding:0;margin-left:1px;font-family:inherit;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5">Ã—</button>
    </span>
  `).join('');
}
function setLogic(l) {
  logic = l;
  const a = document.getElementById('btnAnd'), b = document.getElementById('btnOr');
  if (l === 'AND') {
    a.style.cssText = 'padding:4px 12px;border-radius:7px;font-size:11px;font-weight:700;background:#1D4ED8;color:white;border:1.5px solid #1D4ED8;cursor:pointer;font-family:inherit;';
    b.style.cssText = 'padding:4px 12px;border-radius:7px;font-size:11px;font-weight:700;background:white;color:#64748B;border:1.5px solid #E2E8F0;cursor:pointer;font-family:inherit;';
  } else {
    b.style.cssText = 'padding:4px 12px;border-radius:7px;font-size:11px;font-weight:700;background:#1D4ED8;color:white;border:1.5px solid #1D4ED8;cursor:pointer;font-family:inherit;';
    a.style.cssText = 'padding:4px 12px;border-radius:7px;font-size:11px;font-weight:700;background:white;color:#64748B;border:1.5px solid #E2E8F0;cursor:pointer;font-family:inherit;';
  }
  updateN();
}
function setGender(g) {
  gender = g;
  const styles = {
    active: 'padding:7px 0;font-size:11px;font-weight:700;border-radius:8px;background:#1D4ED8;color:white;border:1.5px solid #1D4ED8;cursor:pointer;font-family:inherit;',
    idle:   'padding:7px 0;font-size:11px;font-weight:700;border-radius:8px;background:white;color:#64748B;border:1.5px solid #E2E8F0;cursor:pointer;font-family:inherit;',
  };
  document.getElementById('gAll').style.cssText    = (g==='all'?styles.active:styles.idle);
  document.getElementById('gMale').style.cssText   = (g==='male'?styles.active:styles.idle);
  document.getElementById('gFemale').style.cssText = (g==='female'?styles.active:styles.idle);
  updateN();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateAge() {
  const lo = Math.min(+document.getElementById('ageMin').value, +document.getElementById('ageMax').value);
  const hi = Math.max(+document.getElementById('ageMin').value, +document.getElementById('ageMax').value);
  document.getElementById('ageLabel').textContent = `${lo}æ­³ ã€œ ${hi}æ­³`;
  document.getElementById('ageTrack').style.left  = lo + '%';
  document.getElementById('ageTrack').style.right = (100 - hi) + '%';
  updateN();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// N-COUNT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcN() {
  const lo = Math.min(+document.getElementById('ageMin').value, +document.getElementById('ageMax').value);
  const hi = Math.max(+document.getElementById('ageMin').value, +document.getElementById('ageMax').value);
  const ageFactor = Math.max(0.01, (hi - lo) / 100);
  const gFactor   = gender === 'all' ? 1.0 : 0.47;
  const tc = selTags.length;
  const cFactor = tc === 0 ? 0.80 : (logic === 'AND' ? Math.pow(0.55, tc) : Math.min(0.85, 0.26 * tc + 0.08));
  const dbCount = document.querySelectorAll('input[type=checkbox]:checked').length;
  const dbFactor = Math.max(0.10, dbCount * 0.38);
  return Math.max(0, Math.round(800000 * ageFactor * gFactor * cFactor * dbFactor));
}
function updateN() {
  const n = calcN();
  const el = document.getElementById('nVal');
  el.textContent = n.toLocaleString('ja-JP');
  const d = document.getElementById('nDisplay');
  d.classList.remove('count-in'); void d.offsetWidth; d.classList.add('count-in');
  renderFunnel(n);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FEASIBILITY RUN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runFeasibility(btn) {
  const orig = btn.innerHTML;
  btn.innerHTML = '<span style="display:inline-block;animation:spin 0.9s linear infinite;">âŸ³</span>&ensp;å®Ÿè¡Œä¸­â€¦';
  btn.disabled = true;
  setTimeout(() => { btn.innerHTML = orig; btn.disabled = false; updateN(); }, 1100);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FUNNEL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFunnel(baseN) {
  const n = baseN !== undefined ? baseN : calcN();
  const lo = Math.min(+document.getElementById('ageMin').value, +document.getElementById('ageMax').value);
  const hi = Math.max(+document.getElementById('ageMin').value, +document.getElementById('ageMax').value);
  const tagLabel = selTags.length > 0 ? selTags.map(t => t.label).join('ãƒ»') : 'ç–¾æ‚£ãƒ»è–¬å‰¤æ¡ä»¶ï¼ˆæœªè¨­å®šï¼‰';
  const gLabel = gender === 'all' ? 'æ€§åˆ¥ï¼ˆå…¨ä½“ï¼‰' : gender === 'male' ? 'æ€§åˆ¥ï¼ˆç”·æ€§ã®ã¿ï¼‰' : 'æ€§åˆ¥ï¼ˆå¥³æ€§ã®ã¿ï¼‰';

  const TOTAL = 120000000;
  const steps = [
    { icon:'ğŸ—„ï¸', label:'NDBå…¨ç™»éŒ²è€…ï¼ˆ2022â€“2024ï¼‰',         n: TOTAL,                 color:'#1D4ED8' },
    { icon:'ğŸ‘¥', label:`å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆ${lo}ã€œ${hi}æ­³ï¼‰`,   n: Math.round(n * 7.8),   color:'#2563EB' },
    { icon:'ğŸ”', label:tagLabel,                           n: Math.round(n * 2.4),   color:'#3B82F6' },
    { icon:'âš§',  label:gLabel,                             n: Math.round(n * 1.2),   color:'#60A5FA' },
    { icon:'âœ…', label:'æœ€çµ‚æŠ½å‡ºå¯¾è±¡è€…',                   n,                         color:'#059669' },
  ];
  const maxN = steps[0].n;
  const wrap = document.getElementById('funnelWrap');
  wrap.innerHTML = steps.map((s, i) => {
    const pct = Math.max(1, Math.round((s.n / maxN) * 100));
    const nStr = s.n >= 10000000 ? `${(s.n/10000000).toFixed(0)}åƒä¸‡` :
                 s.n >= 10000   ? `${(s.n/10000).toFixed(1)}ä¸‡`       : s.n.toLocaleString('ja-JP');
    const isLast = i === steps.length - 1;
    return `
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:14px;width:20px;text-align:center;flex-shrink:0;">${s.icon}</span>
        <div style="flex:1;min-width:0;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
            <span style="font-size:11px;color:${isLast?'#065F46':'#334155'};font-weight:${isLast?700:500};white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(100% - 70px);">${s.label}</span>
            <span style="font-size:11px;font-weight:700;color:${isLast?'#059669':'#0F172A'};flex-shrink:0;margin-left:6px;">${nStr}äºº</span>
          </div>
          <div style="height:8px;border-radius:4px;background:#F1F5F9;overflow:hidden;">
            <div class="funnel-bar" style="height:100%;border-radius:4px;width:${pct}%;background:${s.color};"></div>
          </div>
        </div>
        <span style="font-size:10px;color:#94A3B8;width:32px;text-align:right;flex-shrink:0;">${pct}%</span>
      </div>
      ${i < steps.length - 1 ? '<div style="margin-left:26px;color:#CBD5E1;font-size:11px;">â†“</div>' : ''}
    `;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CHART
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showChart() {
  document.getElementById('chartPlaceholder').style.display = 'none';
  document.getElementById('mainChart').style.display = 'block';
  document.getElementById('chartLegend').style.display = 'flex';
  document.getElementById('chartBtns').style.display = 'flex';
  document.getElementById('statsPanel').style.display = 'block';
  document.getElementById('actionBtns').style.display = 'flex';
  document.getElementById('chartTitle').textContent = 'å¹´ä»£åˆ¥ãƒ»ç”·å¥³åˆ¥ è…¹å›²åŸºæº–è¶…ãˆå‰²åˆ';
  document.getElementById('chartSub').textContent = 'ãƒ‡ãƒ¼ã‚¿: NDBï¼ˆåŒ»ç§‘ãƒ¬ã‚»ãƒ—ãƒˆï¼‹ç‰¹å®šå¥è¨ºï¼‰ 2022â€“2024å¹´ | å¯¾è±¡: ç³–å°¿ç—…æ‚£è€…';

  if (chartInst) chartInst.destroy();
  const ctx = document.getElementById('mainChart').getContext('2d');
  chartInst = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['30ä»£', '40ä»£', '50ä»£', '60ä»£', '70ä»£', '80ä»£', '90ä»£+'],
      datasets: [
        {
          label: 'ç”·æ€§ï¼ˆè…¹å›²åŸºæº–è¶…ãˆ %ï¼‰',
          data: [28, 42, 58, 70, 72, 68, 55],
          backgroundColor: 'rgba(29,78,216,0.72)',
          borderColor: 'rgba(29,78,216,1)',
          borderWidth: 1.5, borderRadius: 5, borderSkipped: false,
        },
        {
          label: 'å¥³æ€§ï¼ˆè…¹å›²åŸºæº–è¶…ãˆ %ï¼‰',
          data: [12, 22, 38, 52, 60, 58, 48],
          backgroundColor: 'rgba(236,72,153,0.68)',
          borderColor: 'rgba(236,72,153,1)',
          borderWidth: 1.5, borderRadius: 5, borderSkipped: false,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      animation: { duration: 650, easing: 'easeOutQuart' },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(15,23,42,0.92)',
          titleFont: { family: 'inherit', size: 12, weight: 'bold' },
          bodyFont:  { family: 'inherit', size: 11 },
          padding: 10, cornerRadius: 8,
          callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.raw}%` },
        },
      },
      scales: {
        x: { grid: { display: false }, ticks: { font: { family: 'inherit', size: 11 }, color: '#64748B' } },
        y: {
          max: 100,
          grid: { color: 'rgba(226,232,240,0.8)' },
          ticks: { font: { family: 'inherit', size: 11 }, color: '#94A3B8', callback: v => v + '%' },
        },
      },
    },
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CHAT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function fmt(t) {
  return t
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br>');
}

function useEx(i) {
  document.getElementById('chatIn').value = EXAMPLES[i];
  document.getElementById('chatIn').focus();
}
function chatKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
}

function sendMsg() {
  const inp = document.getElementById('chatIn');
  const txt = inp.value.trim();
  if (!txt) return;
  inp.value = '';

  addUserBubble(txt);
  addTyping();

  let key = 0;
  if (txt.includes('é«˜è¡€åœ§') || txt.includes('æ¨ç§»') || txt.includes('å¹´æ¬¡')) key = 1;
  else if (txt.includes('æŠ•è–¬') || txt.includes('Top') || txt.includes('çµ„ã¿åˆã‚ã›')) key = 2;

  setTimeout(() => {
    removeTyping();
    const r = AI_RESPS[key];
    addAIBubble(r.text, true, r.doChart);
    if (r.doChart) setTimeout(showChart, 350);
  }, 1500 + Math.random() * 600);
}

function addUserBubble(txt) {
  const wrap = document.getElementById('chatMsgs');
  const d = document.createElement('div');
  d.className = 'slide-up';
  d.style.cssText = 'display:flex;justify-content:flex-end;';
  d.innerHTML = `<div class="chat-bubble-user" style="max-width:86%;padding:9px 14px;font-size:12px;line-height:1.65;">${esc(txt)}</div>`;
  wrap.appendChild(d);
  wrap.scrollTop = wrap.scrollHeight;
}

function addTyping() {
  const wrap = document.getElementById('chatMsgs');
  const d = document.createElement('div');
  d.id = 'typingInd';
  d.className = 'slide-up';
  d.style.cssText = 'display:flex;gap:9px;align-items:flex-start;';
  d.innerHTML = `
    <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#F59E0B,#F97316);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">ğŸ¤–</div>
    <div class="chat-bubble-ai" style="padding:12px 14px;display:flex;gap:5px;align-items:center;">
      <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
    </div>`;
  wrap.appendChild(d);
  wrap.scrollTop = wrap.scrollHeight;
}
function removeTyping() { document.getElementById('typingInd')?.remove(); }

function addAIBubble(text, hasSQL, hasChart) {
  const wrap = document.getElementById('chatMsgs');
  const d = document.createElement('div');
  d.className = 'slide-up';
  d.style.cssText = 'display:flex;gap:9px;align-items:flex-start;';
  const sqlId = `sql${++sqlN}`;
  d.innerHTML = `
    <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#F59E0B,#F97316);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;margin-top:2px;">ğŸ¤–</div>
    <div style="flex:1;min-width:0;">
      <div class="chat-bubble-ai" style="padding:11px 14px;font-size:12px;color:#0F172A;line-height:1.78;">${fmt(text)}
        ${hasChart ? '<div style="margin-top:8px;font-size:11px;color:#059669;font-weight:600;display:flex;align-items:center;gap:4px;"><svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M5 9.2h3V19H5V9.2zM10.6 5h2.8v14h-2.8V5zm5.6 5.4H19V19h-2.8v-8.6z"/></svg>â†’ ä¸­å¤®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚°ãƒ©ãƒ•ã‚’æç”»ã—ã¾ã—ãŸ</div>' : ''}
      </div>
      ${hasSQL ? buildSQLAccordion(sqlId) : ''}
    </div>`;
  wrap.appendChild(d);
  wrap.scrollTop = wrap.scrollHeight;
}

function buildSQLAccordion(id) {
  return `
    <div style="margin-top:7px;">
      <button onclick="toggleSQL('${id}')" style="display:flex;align-items:center;gap:6px;padding:5px 11px;background:#1E293B;border:1px solid rgba(255,255,255,0.08);border-radius:8px;font-size:11px;color:#94A3B8;cursor:pointer;font-family:monospace;letter-spacing:0.03em;transition:background 0.15s;" onmouseover="this.style.background='#263548'" onmouseout="this.style.background='#1E293B'">
        <span id="${id}_ic">â–¶</span>
        <span>SQLã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º</span>
        <span style="margin-left:6px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.10);padding:1px 7px;border-radius:4px;font-size:9.5px;color:#6EE7B7;font-weight:600;">AIè‡ªå‹•ç”Ÿæˆ</span>
      </button>
      <div id="${id}" style="display:none;margin-top:5px;background:#0F172A;border:1px solid rgba(255,255,255,0.07);border-radius:11px;overflow:hidden;">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.06);">
          <span style="font-size:10.5px;color:#64748B;font-family:monospace;">query.sql â€” Databricks SQL</span>
          <div style="display:flex;gap:8px;align-items:center;">
            <span style="font-size:10px;color:#4ADE80;font-family:monospace;">â— å®Ÿè¡Œå¯èƒ½</span>
            <button onclick="copySQL(event)" style="font-size:10px;color:#64748B;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.09);border-radius:5px;padding:2px 8px;cursor:pointer;font-family:inherit;transition:all 0.15s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#64748B'">ã‚³ãƒ”ãƒ¼</button>
          </div>
        </div>
        <div style="overflow-x:auto;padding:12px 14px;max-height:260px;overflow-y:auto;">
          <pre style="margin:0;color:rgba(226,232,240,0.88);">${esc(SQL_CODE)}</pre>
        </div>
      </div>
    </div>`;
}
function toggleSQL(id) {
  const el = document.getElementById(id);
  const ic = document.getElementById(id + '_ic');
  const hidden = el.style.display === 'none';
  el.style.display = hidden ? 'block' : 'none';
  ic.textContent = hidden ? 'â–¼' : 'â–¶';
}
function copySQL(e) {
  navigator.clipboard?.writeText(SQL_CODE).catch(() => {});
  e.target.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆ';
  setTimeout(() => { e.target.textContent = 'ã‚³ãƒ”ãƒ¼'; }, 2000);
}
function clearChat() {
  const wrap = document.getElementById('chatMsgs');
  const kids = Array.from(wrap.children);
  kids.slice(1).forEach(k => k.remove());
}

// pulse animation for header dot
const s = document.createElement('style');
s.textContent = '@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}';
document.head.appendChild(s);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATABRICKS MODAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let dbStep = 1;
let dbTemplate = null;
const DB_STEPS = ['ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹æ¥ç¶š', 'ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›è¨­å®š', 'åˆ†æãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', 'å®Ÿè¡Œãƒ»ç¢ºèª'];

function openDBModal() {
  dbStep = 1;
  dbTemplate = null;
  document.getElementById('dbModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
  renderDBStep();
}
function closeDBModal() {
  document.getElementById('dbModal').style.display = 'none';
  document.body.style.overflow = '';
}
function dbStepNext() {
  if (dbStep < 4) { dbStep++; renderDBStep(); document.getElementById('dbContent').scrollTop = 0; }
}
function dbStepPrev() {
  if (dbStep > 1) { dbStep--; renderDBStep(); document.getElementById('dbContent').scrollTop = 0; }
}

function renderDBStepper() {
  const colors = { active:'#4338ca', done:'#4338ca', idle:'#E2E8F0' };
  document.getElementById('dbStepper').innerHTML = `
    <div style="display:flex;align-items:flex-start;gap:0;margin-bottom:16px;">
      ${DB_STEPS.map((label, i) => {
        const n = i + 1, active = n === dbStep, done = n < dbStep;
        return `
          ${i > 0 ? `<div style="flex:1;height:2px;margin-top:15px;background:${done?colors.done:'#E2E8F0'};transition:background 0.3s;min-width:12px;"></div>` : ''}
          <div style="display:flex;flex-direction:column;align-items:center;gap:5px;flex-shrink:0;">
            <div style="width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;transition:all 0.2s;
              ${done   ? 'background:#4338ca;color:white;'
                       : active ? 'background:#4338ca;color:white;box-shadow:0 0 0 5px rgba(67,56,202,0.16);'
                       : 'background:#F1F5F9;color:#94A3B8;'}">
              ${done ? 'âœ“' : n}
            </div>
            <div style="font-size:9.5px;font-weight:${active?700:500};color:${active?'#4338ca':done?'#475569':'#94A3B8'};white-space:nowrap;text-align:center;">${label}</div>
          </div>`;
      }).join('')}
    </div>`;
  document.getElementById('dbStepLabel').textContent = `${dbStep} / ${DB_STEPS.length}`;
  document.getElementById('dbPrevBtn').style.visibility = dbStep > 1 ? 'visible' : 'hidden';
  const nb = document.getElementById('dbNextBtn');
  if (dbStep === 4) { nb.style.display = 'none'; } else {
    nb.style.display = '';
    nb.textContent = dbStep === 3 ? 'ç¢ºèªã¸ â†’' : 'æ¬¡ã¸ â†’';
  }
}

function renderDBStep() {
  renderDBStepper();
  const el = document.getElementById('dbContent');
  el.innerHTML = [dbStep1HTML, dbStep2HTML, dbStep3HTML, dbStep4HTML][dbStep - 1]();
}

// â”€â”€ Step 1: Workspace Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dbStep1HTML() {
  return `
  <div style="display:flex;flex-direction:column;gap:18px;">
    <div style="background:rgba(67,56,202,0.05);border:1px solid rgba(67,56,202,0.18);border-radius:12px;padding:13px 16px;display:flex;gap:10px;">
      <svg width="15" height="15" fill="#4338ca" viewBox="0 0 24 24" style="flex-shrink:0;margin-top:1px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
      <div style="font-size:11.5px;color:#312e81;line-height:1.75;">Databricks ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¸ã®æ¥ç¶šæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®ã¿ä¿æŒã•ã‚Œã€å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã¸ã®é€ä¿¡ã¯è¡Œã„ã¾ã›ã‚“ã€‚</div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
      <div style="grid-column:1/-1;">
        <label class="label-sm" style="display:block;margin-bottom:6px;">Workspace URL</label>
        <div style="position:relative;">
          <span style="position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:11px;color:#94A3B8;font-family:monospace;">https://</span>
          <input id="dbUrl" type="text" value="adb-7890123456789012.12.azuredatabricks.net"
            style="width:100%;padding:9px 10px 9px 60px;font-size:12px;border:1.5px solid #E2E8F0;border-radius:9px;background:#F8FAFC;color:#0F172A;font-family:monospace;box-sizing:border-box;">
        </div>
      </div>
      <div>
        <label class="label-sm" style="display:block;margin-bottom:6px;">ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆPATï¼‰</label>
        <input id="dbPat" type="password" placeholder="dapiâ€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          style="width:100%;padding:9px 12px;font-size:12px;border:1.5px solid #E2E8F0;border-radius:9px;background:#F8FAFC;color:#0F172A;font-family:monospace;box-sizing:border-box;">
      </div>
      <div>
        <label class="label-sm" style="display:block;margin-bottom:6px;">ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼IDï¼ˆçœç•¥å¯ï¼‰</label>
        <input id="dbClusterId" type="text" placeholder="0123-456789-abcdefgh"
          style="width:100%;padding:9px 12px;font-size:12px;border:1.5px solid #E2E8F0;border-radius:9px;background:#F8FAFC;color:#0F172A;font-family:monospace;box-sizing:border-box;">
      </div>
      <div>
        <label class="label-sm" style="display:block;margin-bottom:6px;">Unity Catalog</label>
        <select style="width:100%;padding:9px 12px;font-size:12px;border:1.5px solid #E2E8F0;border-radius:9px;background:white;color:#0F172A;cursor:pointer;font-family:inherit;box-sizing:border-box;">
          <option>mhlw_research</option><option>ndb_analytics</option><option>hive_metastore</option>
        </select>
      </div>
      <div>
        <label class="label-sm" style="display:block;margin-bottom:6px;">ã‚¹ã‚­ãƒ¼ãƒï¼ˆDBï¼‰</label>
        <select style="width:100%;padding:9px 12px;font-size:12px;border:1.5px solid #E2E8F0;border-radius:9px;background:white;color:#0F172A;cursor:pointer;font-family:inherit;box-sizing:border-box;">
          <option>cohort_research</option><option>analysis_staging</option><option>ndb_extract</option>
        </select>
      </div>
    </div>

    <!-- Connection test -->
    <div style="background:#F8FAFC;border:1.5px solid #E2E8F0;border-radius:11px;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:14px;">
      <div>
        <div style="font-size:12.5px;font-weight:600;color:#0F172A;">æ¥ç¶šãƒ†ã‚¹ãƒˆ</div>
        <div id="dbConnStatus" style="font-size:11px;color:#94A3B8;margin-top:3px;">æœªãƒ†ã‚¹ãƒˆ â€” ãƒˆãƒ¼ã‚¯ãƒ³å…¥åŠ›å¾Œã«ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„</div>
      </div>
      <button onclick="testDBConn()" style="padding:8px 18px;border-radius:8px;font-size:12px;font-weight:600;background:white;border:1.5px solid #E2E8F0;color:#475569;cursor:pointer;font-family:inherit;transition:all 0.15s;white-space:nowrap;flex-shrink:0;" onmouseover="this.style.background='#F1F5F9'" onmouseout="this.style.background='white'">æ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    </div>

    <div style="background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.22);border-radius:10px;padding:12px 14px;font-size:11px;color:#78350F;line-height:1.75;">
      ğŸ”’ <strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼š</strong> ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ¢ãƒªã«ã®ã¿ä¿æŒã•ã‚Œã¾ã™ã€‚VPN çµŒç”±ãƒ»IPã‚¢ãƒ‰ãƒ¬ã‚¹åˆ¶é™ä»˜ããƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã§ã®åˆ©ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
    </div>
  </div>`;
}

function testDBConn() {
  const el = document.getElementById('dbConnStatus');
  el.innerHTML = '<span class="db-spin">âŸ³</span>&ensp;æ¥ç¶šç¢ºèªä¸­â€¦';
  el.style.color = '#64748B';
  setTimeout(() => {
    el.innerHTML = '<span style="color:#059669;font-weight:700;">âœ“ æ¥ç¶šæˆåŠŸ</span>&ensp;<span style="color:#94A3B8;">Databricks Runtime 15.4 ML / Unity Catalog æœ‰åŠ¹</span>';
    el.style.color = '';
  }, 1400);
}

// â”€â”€ Step 2: Export Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dbStep2HTML() {
  const n = calcN();
  const tbl = 'cohort_' + (selTags.map(t => t.code.toLowerCase()).join('_') || 'all')
              + '_' + new Date().getFullYear()
              + '_q' + Math.ceil((new Date().getMonth() + 1) / 3);
  const gb = (n * 0.00012).toFixed(1);
  const tagStr = selTags.map(t => t.label).join('ãƒ»') || 'ï¼ˆæœªè¨­å®šï¼‰';

  return `
  <div style="display:flex;flex-direction:column;gap:18px;">
    <!-- Cohort badge -->
    <div style="background:linear-gradient(135deg,#EFF6FF,#F0F9FF);border:1px solid #BFDBFE;border-radius:12px;padding:13px 16px;display:flex;align-items:center;gap:14px;">
      <div style="width:42px;height:42px;background:#1D4ED8;border-radius:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:19px;">ğŸ‘¥</div>
      <div style="flex:1;">
        <div style="font-size:12.5px;font-weight:700;color:#1E3A8A;">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ã‚³ãƒ›ãƒ¼ãƒˆ</div>
        <div style="font-size:11px;color:#3B82F6;margin-top:3px;">${tagStr}</div>
      </div>
      <div style="text-align:right;flex-shrink:0;">
        <div style="font-size:22px;font-weight:900;color:#1D4ED8;letter-spacing:-0.03em;">${n.toLocaleString('ja-JP')}<span style="font-size:11px;font-weight:600;color:#3B82F6;margin-left:3px;">å</span></div>
        <div style="font-size:10px;color:#64748B;">æ¨å®š ${gb} GB</div>
      </div>
    </div>

    <!-- Table name -->
    <div>
      <label class="label-sm" style="display:block;margin-bottom:6px;">å‡ºåŠ›ãƒ†ãƒ¼ãƒ–ãƒ«å</label>
      <input id="dbTableName" type="text" value="${tbl}"
        style="width:100%;padding:9px 12px;font-size:12px;border:1.5px solid #E2E8F0;border-radius:9px;background:#F8FAFC;color:#0F172A;font-family:monospace;box-sizing:border-box;">
      <div style="font-size:10.5px;color:#94A3B8;margin-top:4px;">å®Œå…¨ä¿®é£¾å:&ensp;<code style="color:#475569;background:#F1F5F9;padding:1px 6px;border-radius:4px;">mhlw_research.cohort_research.${tbl}</code></div>
    </div>

    <!-- Format -->
    <div>
      <label class="label-sm" style="display:block;margin-bottom:8px;">å‡ºåŠ›å½¢å¼</label>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
        ${[
          {val:'delta',  label:'Delta Table', sub:'æ¨å¥¨ Â· ACIDä¿è¨¼',    icon:'â–³', color:'#1D4ED8', bg:'#EFF6FF', checked:true},
          {val:'parquet',label:'Parquet',      sub:'é«˜é€Ÿèª­ã¿è¾¼ã¿',        icon:'â¬¡', color:'#7C3AED', bg:'#F5F3FF', checked:false},
          {val:'csv',    label:'CSV',          sub:'æ±ç”¨ãƒ»å¤–éƒ¨é€£æºå‘ã‘',  icon:'â˜°', color:'#059669', bg:'#ECFDF5', checked:false},
        ].map(f => `
          <label style="display:flex;flex-direction:column;gap:5px;padding:11px 13px;border:2px solid ${f.checked?f.color:'#E2E8F0'};border-radius:10px;cursor:pointer;background:${f.checked?f.bg:'white'};transition:all 0.15s;">
            <div style="display:flex;align-items:center;gap:7px;">
              <input type="radio" name="dbFmt" value="${f.val}" ${f.checked?'checked':''} style="accent-color:${f.color};">
              <span style="font-size:14px;">${f.icon}</span>
              <span style="font-size:12px;font-weight:700;color:#0F172A;">${f.label}</span>
            </div>
            <span style="font-size:10.5px;color:#64748B;padding-left:22px;">${f.sub}</span>
          </label>`).join('')}
      </div>
    </div>

    <!-- Columns -->
    <div>
      <label class="label-sm" style="display:block;margin-bottom:8px;">å‡ºåŠ›ã‚«ãƒ©ãƒ è¨­å®š</label>
      <div style="border:1.5px solid #E2E8F0;border-radius:11px;overflow:hidden;">
        ${[
          {col:'patient_id',          label:'patient_id â€” ç–‘ä¼¼IDï¼ˆåŒ¿ååŒ–æ¸ˆã¿ï¼‰',     note:'å¿…é ˆ',   color:'#059669', checked:true,  locked:true},
          {col:'age_group',           label:'age_group â€” å¹´é½¢ç¾¤ï¼ˆ10æ­³åˆ»ã¿ï¼‰',         note:'æ¨å¥¨',   color:'#1D4ED8', checked:true,  locked:false},
          {col:'gender',              label:'gender â€” æ€§åˆ¥ï¼ˆM/Fï¼‰',                   note:'æ¨å¥¨',   color:'#1D4ED8', checked:true,  locked:false},
          {col:'diagnosis_codes',     label:'diagnosis_codes â€” å‚·ç—…åã‚³ãƒ¼ãƒ‰ï¼ˆICD-10ï¼‰',note:'æ¨å¥¨',  color:'#1D4ED8', checked:true,  locked:false},
          {col:'prescription_history',label:'prescription_history â€” å‡¦æ–¹æ­´ï¼ˆYMåˆ¥ï¼‰',  note:'æ¨å¥¨',   color:'#1D4ED8', checked:true,  locked:false},
          {col:'checkup_data',        label:'checkup_data â€” ç‰¹å®šå¥è¨ºå€¤ï¼ˆè¡€åœ§ãƒ»è…¹å›²ç­‰ï¼‰',note:'æ¨å¥¨', color:'#1D4ED8', checked:true,  locked:false},
          {col:'region_code',         label:'region_code â€” åœ°åŸŸã‚³ãƒ¼ãƒ‰',               note:'âš  è¦ç¢ºèª',color:'#D97706',checked:false, locked:false},
          {col:'income_bracket',      label:'income_bracket â€” æ‰€å¾—éšå±¤',              note:'âš  æº–è­˜åˆ¥å­',color:'#DC2626',checked:false,locked:false},
        ].map((c, i, arr) => `
          <label style="display:flex;align-items:center;gap:10px;padding:9px 14px;${i<arr.length-1?'border-bottom:1px solid #F1F5F9;':''}cursor:${c.locked?'default':'pointer'};background:${c.locked?'#F9FFF9':'white'};">
            <input type="checkbox" ${c.checked?'checked':''} ${c.locked?'disabled':''} style="width:14px;height:14px;accent-color:${c.color};flex-shrink:0;">
            <span style="font-size:11.5px;font-family:monospace;color:#0F172A;flex:1;">${c.label}</span>
            <span style="font-size:10px;color:${c.color};background:${c.color==='#059669'?'rgba(5,150,105,0.10)':c.color==='#D97706'?'rgba(217,119,6,0.10)':c.color==='#DC2626'?'rgba(220,38,38,0.10)':'rgba(29,78,216,0.07)'};padding:2px 8px;border-radius:5px;font-weight:700;flex-shrink:0;">${c.note}</span>
          </label>`).join('')}
      </div>
    </div>

    <!-- Privacy -->
    <div style="background:rgba(245,158,11,0.05);border:1px solid rgba(245,158,11,0.22);border-radius:11px;padding:14px 16px;">
      <div style="font-size:12px;font-weight:700;color:#78350F;margin-bottom:10px;">ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·è¨­å®š</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        ${[
          {label:'k-åŒ¿ååŒ–å‡¦ç†ï¼ˆk=5ï¼‰',         note:'åŒä¸€å±æ€§çµ„ã¿åˆã‚ã›ãŒ5ä»¶æœªæº€ã®å ´åˆã¯éå‡ºåŠ›',         checked:true},
          {label:'ã‚»ãƒ«æŠ‘åˆ¶ï¼ˆn &lt; 10ï¼‰',        note:'é›†è¨ˆå€¤10æœªæº€ã®ã‚»ãƒ«ã‚’ã€Œï¼Šã€ã«ç½®æ›',                 checked:true},
          {label:'æº–è­˜åˆ¥å­ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆSHA-256ï¼‰',note:'ç”Ÿå¹´æœˆæ—¥ãƒ»ä½æ‰€ã‚³ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–',                 checked:true},
          {label:'å·®åˆ†ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ï¼ˆÎµ=1.0ï¼‰',    note:'ãƒã‚¤ã‚ºä»˜åŠ ã«ã‚ˆã‚‹çµ±è¨ˆçš„åŒ¿ååŒ–ï¼ˆBetaï¼‰',             checked:false},
        ].map(p => `
          <label style="display:flex;align-items:flex-start;gap:9px;cursor:pointer;">
            <input type="checkbox" ${p.checked?'checked':''} style="width:14px;height:14px;accent-color:#D97706;flex-shrink:0;margin-top:2px;">
            <div>
              <div style="font-size:12px;font-weight:600;color:#78350F;">${p.label}</div>
              <div style="font-size:10.5px;color:#92400E;margin-top:1px;">${p.note}</div>
            </div>
          </label>`).join('')}
      </div>
    </div>
  </div>`;
}

// â”€â”€ Step 3: Analysis Template â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DB_TEMPLATES = [
  {id:'survival', icon:'ğŸ“ˆ', title:'ç”Ÿå­˜æ™‚é–“åˆ†æ',         sub:'Kaplan-Meier / Coxæ¯”ä¾‹ãƒã‚¶ãƒ¼ãƒ‰',
   desc:'ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼ˆå…¥é™¢ãƒ»æŠ•è–¬é–‹å§‹ãƒ»åˆä½µç—‡ï¼‰ã¾ã§ã®æ™‚é–“ã‚’åˆ†æã€‚ãƒã‚¶ãƒ¼ãƒ‰æ¯”ãƒ»95%CIãƒ»ãƒ­ã‚°ãƒ©ãƒ³ã‚¯æ¤œå®šã‚’è‡ªå‹•ç®—å‡ºã—ã¾ã™ã€‚',
   tags:['Python','lifelines','matplotlib'], time:'~15åˆ†', color:'#1D4ED8', bg:'#EFF6FF'},
  {id:'ml',       icon:'ğŸ¤–', title:'æ©Ÿæ¢°å­¦ç¿’ äºˆå¾Œäºˆæ¸¬',    sub:'XGBoost / Random Forest + SHAP',
   desc:'åˆä½µç—‡ç™ºç—‡ãƒ»å†å…¥é™¢ãƒªã‚¹ã‚¯ã‚’äºˆæ¸¬ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã€‚SHAPå€¤ã«ã‚ˆã‚‹ç‰¹å¾´é‡é‡è¦åº¦ã®å¯è¦–åŒ–ã¨äº¤å·®æ¤œè¨¼ä»˜ãã€‚',
   tags:['Python','XGBoost','SHAP','sklearn'], time:'~30åˆ†', color:'#7C3AED', bg:'#F5F3FF'},
  {id:'eda',      icon:'ğŸ“Š', title:'è¨˜è¿°çµ±è¨ˆãƒ»å¯è¦–åŒ– EDA', sub:'åŸºæœ¬çµ±è¨ˆé‡ãƒ»åˆ†å¸ƒãƒ»ç›¸é–¢åˆ†æ',
   desc:'ç ”ç©¶è¨ˆç”»æ›¸ãƒ»è«–æ–‡å‘ã‘ã®åŸºæœ¬çµ±è¨ˆè¡¨ãƒ»åˆ†å¸ƒã‚°ãƒ©ãƒ•ãƒ»Spearmanç›¸é–¢ãƒãƒˆãƒªã‚¯ã‚¹ã‚’è‡ªå‹•ç”Ÿæˆã€‚PDFå‡ºåŠ›å¯¾å¿œã€‚',
   tags:['Python','pandas','seaborn','fpdf'], time:'~10åˆ†', color:'#059669', bg:'#ECFDF5'},
  {id:'custom',   icon:'âš™ï¸', title:'ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯', sub:'æ—¢å­˜ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œ',
   desc:'Databricksä¸Šã®æ—¢å­˜ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ãƒ‘ã‚¹ã‚’å…¥åŠ›ã€‚ã‚³ãƒ›ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã—ã¾ã™ã€‚ä»»æ„è¨€èªãƒ»ä»»æ„ãƒ­ã‚¸ãƒƒã‚¯å¯¾å¿œã€‚',
   tags:['ä»»æ„è¨€èª'], time:'ä¸å®š', color:'#475569', bg:'#F8FAFC'},
];

function dbStep3HTML() {
  return `
  <div style="display:flex;flex-direction:column;gap:16px;">
    <div style="font-size:12px;color:#475569;line-height:1.75;">å®Ÿè¡Œã™ã‚‹åˆ†æãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚é¸æŠå¾Œã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼è¨­å®šã‚’èª¿æ•´ã§ãã¾ã™ã€‚</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      ${DB_TEMPLATES.map(t => `
        <div class="db-tmpl-card${dbTemplate===t.id?' sel-'+t.id:''}" id="tmpl_${t.id}" onclick="selectDBTemplate('${t.id}')">
          ${dbTemplate===t.id?`<div style="position:absolute;top:10px;right:10px;width:22px;height:22px;border-radius:50%;background:${t.color};display:flex;align-items:center;justify-content:center;font-size:12px;color:white;font-weight:700;">âœ“</div>`:''}
          <div style="font-size:24px;margin-bottom:8px;">${t.icon}</div>
          <div style="font-size:13px;font-weight:700;color:#0F172A;">${t.title}</div>
          <div style="font-size:10.5px;color:${t.color};font-weight:600;margin-top:2px;">${t.sub}</div>
          <div style="font-size:11px;color:#64748B;margin-top:7px;line-height:1.65;">${t.desc}</div>
          <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:10px;align-items:center;">
            ${t.tags.map(tag=>`<span style="font-size:9.5px;padding:2px 7px;border-radius:4px;background:${t.bg};border:1px solid ${t.color}40;color:${t.color};font-weight:600;font-family:monospace;">${tag}</span>`).join('')}
            <span style="font-size:9.5px;padding:2px 7px;border-radius:4px;background:#F1F5F9;color:#64748B;font-weight:600;margin-left:auto;">â± ${t.time}</span>
          </div>
        </div>`).join('')}
    </div>

    <!-- Cluster settings -->
    <div style="border:1.5px solid #E2E8F0;border-radius:12px;padding:15px 16px;">
      <div style="font-size:12.5px;font-weight:700;color:#0F172A;margin-bottom:12px;">ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ»å®Ÿè¡Œè¨­å®š</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div>
          <label class="label-sm" style="display:block;margin-bottom:5px;">ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—</label>
          <select style="width:100%;padding:8px 11px;font-size:12px;border:1.5px solid #E2E8F0;border-radius:8px;background:white;color:#0F172A;cursor:pointer;font-family:inherit;">
            <option>Standard_DS3_v2ï¼ˆ8ã‚³ã‚¢ 28GBï¼‰</option>
            <option>Standard_DS4_v2ï¼ˆ16ã‚³ã‚¢ 56GBï¼‰</option>
            <option>æ—¢å­˜ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ä½¿ç”¨ï¼ˆIDã§æŒ‡å®šï¼‰</option>
          </select>
        </div>
        <div>
          <label class="label-sm" style="display:block;margin-bottom:5px;">æœ€å¤§å®Ÿè¡Œæ™‚é–“</label>
          <select style="width:100%;padding:8px 11px;font-size:12px;border:1.5px solid #E2E8F0;border-radius:8px;background:white;color:#0F172A;cursor:pointer;font-family:inherit;">
            <option>1æ™‚é–“</option><option selected>2æ™‚é–“</option><option>4æ™‚é–“</option><option>8æ™‚é–“</option>
          </select>
        </div>
        <div>
          <label class="label-sm" style="display:block;margin-bottom:5px;">å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
          <select style="width:100%;padding:8px 11px;font-size:12px;border:1.5px solid #E2E8F0;border-radius:8px;background:white;color:#0F172A;cursor:pointer;font-family:inherit;">
            <option selected>ä»Šã™ãå®Ÿè¡Œ</option>
            <option>å¤œé–“ãƒãƒƒãƒï¼ˆç¿Œæ—¥ 02:00ï¼‰</option>
            <option>ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</option>
          </select>
        </div>
        <div>
          <label class="label-sm" style="display:block;margin-bottom:5px;">å®Œäº†é€šçŸ¥</label>
          <select style="width:100%;padding:8px 11px;font-size:12px;border:1.5px solid #E2E8F0;border-radius:8px;background:white;color:#0F172A;cursor:pointer;font-family:inherit;">
            <option>Eãƒ¡ãƒ¼ãƒ«é€šçŸ¥</option><option selected>Slack ãƒãƒ£ãƒ³ãƒãƒ«é€šçŸ¥</option><option>é€šçŸ¥ãªã—</option>
          </select>
        </div>
      </div>
    </div>
  </div>`;
}

function selectDBTemplate(id) {
  dbTemplate = id;
  document.getElementById('dbContent').innerHTML = dbStep3HTML();
}

// â”€â”€ Step 4: Execute & Confirm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dbStep4HTML() {
  const n = calcN();
  const lo = Math.min(+document.getElementById('ageMin').value, +document.getElementById('ageMax').value);
  const hi = Math.max(+document.getElementById('ageMin').value, +document.getElementById('ageMax').value);
  const tmplLabel = dbTemplate ? DB_TEMPLATES.find(t=>t.id===dbTemplate)?.title : 'è¨˜è¿°çµ±è¨ˆãƒ»å¯è¦–åŒ– EDA';
  const tbl = 'cohort_' + (selTags.map(t=>t.code.toLowerCase()).join('_')||'all')
              + '_' + new Date().getFullYear()
              + '_q' + Math.ceil((new Date().getMonth()+1)/3);
  const tagStr = selTags.map(t=>t.label).join(` ${logic} `) || 'ï¼ˆæœªè¨­å®šï¼‰';
  const gStr = gender==='all'?'å…¨æ€§åˆ¥':gender==='male'?'ç”·æ€§':'å¥³æ€§';

  return `
  <div style="display:flex;flex-direction:column;gap:16px;">
    <!-- Summary -->
    <div style="border:1.5px solid #E2E8F0;border-radius:13px;overflow:hidden;">
      <div style="padding:11px 16px;background:#F8FAFC;border-bottom:1px solid #F1F5F9;font-size:12px;font-weight:700;color:#0F172A;display:flex;align-items:center;gap:7px;">
        <svg width="13" height="13" fill="#4338ca" viewBox="0 0 24 24"><path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-2 .89-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.11-.9-2-2-2zm0 16H5V9h14v11z"/></svg>
        ã‚¸ãƒ§ãƒ–æŠ•å…¥ã‚µãƒãƒªãƒ¼
      </div>
      <div style="padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:11px;">
        ${[
          {label:'ã‚³ãƒ›ãƒ¼ãƒˆå®šç¾©',        val:tagStr},
          {label:'å¹´é½¢ãƒ»æ€§åˆ¥',           val:`${lo}ã€œ${hi}æ­³ / ${gStr}`},
          {label:'è¦³å¯ŸæœŸé–“',             val:`${document.getElementById('obsStart').value}ã€œ${document.getElementById('obsEnd').value}å¹´`},
          {label:'æ¨å®šå¯¾è±¡è€…æ•°',         val:`ç´„ ${n.toLocaleString('ja-JP')} å`},
          {label:'å‡ºåŠ›ãƒ†ãƒ¼ãƒ–ãƒ«',         val:`mhlw_research.cohort_research.${tbl}`},
          {label:'åˆ†æãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ',     val:tmplLabel||'è¨˜è¿°çµ±è¨ˆãƒ»å¯è¦–åŒ– EDA'},
          {label:'ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼',           val:'Standard_DS3_v2ï¼ˆ8ã‚³ã‚¢ 28GBï¼‰'},
          {label:'æœ€å¤§å®Ÿè¡Œæ™‚é–“',         val:'2æ™‚é–“'},
        ].map(r=>`
          <div>
            <div style="font-size:9.5px;font-weight:700;color:#64748B;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:3px;">${r.label}</div>
            <div style="font-size:12px;color:#0F172A;font-weight:500;word-break:break-all;">${r.val}</div>
          </div>`).join('')}
      </div>
    </div>

    <!-- Launch area -->
    <div id="dbJobArea">
      <div style="background:linear-gradient(135deg,#0F2044,#1e1b4b 50%,#312e81);border-radius:14px;padding:22px;text-align:center;">
        <div style="font-size:12.5px;color:rgba(255,255,255,0.80);margin-bottom:6px;font-weight:600;">æº–å‚™å®Œäº† â€” ã‚¸ãƒ§ãƒ–ã‚’æŠ•å…¥ã—ã¦åˆ†æã‚’é–‹å§‹ã—ã¾ã™</div>
        <div style="font-size:11px;color:rgba(147,197,253,0.65);margin-bottom:18px;line-height:1.7;">å®Ÿè¡Œå¾Œã¯ã“ã®ç”»é¢ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«é€²è¡ŒçŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ã€‚<br>ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®çµæœã¯ Databricks Workspace ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
        <button onclick="launchDBJob()" style="padding:14px 40px;font-size:14px;font-weight:700;color:white;border:none;border-radius:12px;cursor:pointer;font-family:inherit;background:linear-gradient(135deg,#ea580c,#f97316,#fb923c);box-shadow:0 4px 22px rgba(249,115,22,0.50),inset 0 1px 0 rgba(255,255,255,0.15);transition:all 0.18s;display:inline-flex;align-items:center;gap:9px;" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 7px 30px rgba(249,115,22,0.65)'" onmouseout="this.style.transform='';this.style.boxShadow='0 4px 22px rgba(249,115,22,0.50)'">
          ğŸš€&ensp;Databricks ã‚¸ãƒ§ãƒ–ã‚’æŠ•å…¥
        </button>
      </div>
    </div>

    <!-- Compliance -->
    <div style="background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.22);border-radius:10px;padding:12px 14px;font-size:11px;color:#78350F;line-height:1.8;">
      âš ï¸ <strong>ãƒ‡ãƒ¼ã‚¿æŒå‡ºç”³è«‹ã®ç¢ºèªï¼š</strong> æœ¬ã‚¸ãƒ§ãƒ–ã¯å€«ç†å¯©æŸ»æ‰¿èªãƒ»ãƒ‡ãƒ¼ã‚¿åˆ©ç”¨ç”³è«‹ãŒå®Œäº†ã—ã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚å®Ÿè¡Œãƒ­ã‚°ã¯è‡ªå‹•çš„ã«ç›£æŸ»è¨¼è·¡ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚<br>
      <span style="color:#B45309;font-weight:700;cursor:pointer;text-decoration:underline;">â†’ ç”³è«‹æ›¸ã«åæ˜ ã™ã‚‹ï¼ˆé€£å‹•ï¼‰</span>
    </div>
  </div>`;
}

// â”€â”€ Job Execution Simulation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DB_JOB_STEPS = [
  {icon:'ğŸ”', label:'ã‚³ãƒ›ãƒ¼ãƒˆæ¡ä»¶ã‚’ SQL åŒ–â€¦',        pct:12},
  {icon:'ğŸ“¦', label:'NDB ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºä¸­â€¦',          pct:32},
  {icon:'ğŸ”’', label:'k-åŒ¿ååŒ–ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼å‡¦ç†â€¦',    pct:54},
  {icon:'ğŸ’¾', label:'Delta Lake ã¸æ›¸ãè¾¼ã¿ä¸­â€¦',       pct:72},
  {icon:'ğŸ““', label:'ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¸ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™â€¦',    pct:88},
  {icon:'âœ…', label:'ã‚¸ãƒ§ãƒ–å®Œäº†ï¼',                   pct:100},
];

function launchDBJob() {
  document.getElementById('dbNextBtn').style.display = 'none';
  document.getElementById('dbPrevBtn').style.visibility = 'hidden';
  const runId = '#' + (Math.floor(Math.random() * 90000) + 10000);
  let idx = 0;

  function nextStep() {
    if (idx >= DB_JOB_STEPS.length) return;
    const cur = DB_JOB_STEPS[idx++];
    renderJobProgress(cur, runId);
    if (cur.pct < 100) setTimeout(nextStep, 700 + Math.random() * 600);
    else setTimeout(() => renderJobComplete(runId), 400);
  }
  renderJobProgress({icon:'âŸ³', label:'ã‚¸ãƒ§ãƒ–ã‚’æŠ•å…¥ä¸­â€¦', pct:4}, runId);
  setTimeout(nextStep, 500);
}

function renderJobProgress(cur, runId) {
  const area = document.getElementById('dbJobArea');
  if (!area) return;
  area.innerHTML = `
    <div style="border:1.5px solid #E2E8F0;border-radius:14px;overflow:hidden;">
      <div style="padding:12px 16px;background:linear-gradient(135deg,#0F2044,#1e1b4b);display:flex;align-items:center;gap:10px;">
        <div style="width:9px;height:9px;border-radius:50%;background:#4ADE80;box-shadow:0 0 8px rgba(74,222,128,0.75);flex-shrink:0;"></div>
        <span style="color:white;font-weight:600;font-size:13px;">ã‚¸ãƒ§ãƒ–å®Ÿè¡Œä¸­</span>
        <span style="color:rgba(147,197,253,0.65);font-size:10.5px;font-family:monospace;margin-left:auto;">Run ID: ${runId}</span>
      </div>
      <div style="padding:16px;">
        <div style="margin-bottom:14px;">
          <div style="display:flex;justify-content:space-between;font-size:11.5px;color:#475569;margin-bottom:7px;">
            <span>${cur.icon}&ensp;${cur.label}</span>
            <span style="font-weight:700;color:#4338ca;">${cur.pct}%</span>
          </div>
          <div style="height:9px;border-radius:5px;background:#F1F5F9;overflow:hidden;">
            <div style="height:100%;border-radius:5px;width:${cur.pct}%;background:linear-gradient(to right,#4338ca,#818cf8);transition:width 0.55s cubic-bezier(0.22,1,0.36,1);"></div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          ${DB_JOB_STEPS.map(s => {
            const done = s.pct <= cur.pct;
            return `<div style="display:flex;align-items:center;gap:9px;font-size:11.5px;">
              <div style="width:18px;height:18px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;${done?'background:#4338ca;color:white;':'background:#F1F5F9;color:#CBD5E1;'}">
                ${done?'âœ“':''}
              </div>
              <span style="color:${done?'#0F172A':'#CBD5E1'};font-weight:${done?500:400};">${s.label}</span>
            </div>`;}).join('')}
        </div>
      </div>
    </div>`;
}

function renderJobComplete(runId) {
  const area = document.getElementById('dbJobArea');
  if (!area) return;
  const tbl = 'cohort_' + (selTags.map(t=>t.code.toLowerCase()).join('_')||'all')
              + '_' + new Date().getFullYear()
              + '_q' + Math.ceil((new Date().getMonth()+1)/3);
  area.innerHTML = `
    <div style="border:2px solid #059669;border-radius:14px;overflow:hidden;">
      <div style="padding:13px 16px;background:linear-gradient(135deg,#064e3b,#059669);display:flex;align-items:center;gap:10px;">
        <div style="width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;">âœ…</div>
        <span style="color:white;font-weight:700;font-size:13.5px;">ã‚¸ãƒ§ãƒ–å®Œäº†</span>
        <span style="color:rgba(110,231,183,0.75);font-size:10.5px;font-family:monospace;margin-left:auto;">Run ID: ${runId}&ensp;Â·&ensp;å‡¦ç†æ™‚é–“: ç´„4åˆ†12ç§’</span>
      </div>
      <div style="padding:16px 18px;background:#ECFDF5;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
          <div style="background:white;border:1px solid #A7F3D0;border-radius:10px;padding:12px 14px;">
            <div style="font-size:9.5px;color:#059669;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:3px;">å‡ºåŠ›ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°</div>
            <div style="font-size:22px;font-weight:900;color:#065F46;letter-spacing:-0.02em;">${calcN().toLocaleString('ja-JP')}<span style="font-size:11px;font-weight:600;margin-left:3px;">ä»¶</span></div>
          </div>
          <div style="background:white;border:1px solid #A7F3D0;border-radius:10px;padding:12px 14px;">
            <div style="font-size:9.5px;color:#059669;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:3px;">Delta Table</div>
            <div style="font-size:10.5px;font-weight:600;color:#065F46;font-family:monospace;word-break:break-all;">${tbl}</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;">
          <button onclick="closeDBModal()" style="flex:1;padding:11px;border-radius:10px;font-size:12.5px;font-weight:700;background:white;border:2px solid #059669;color:#059669;cursor:pointer;font-family:inherit;transition:all 0.15s;" onmouseover="this.style.background='#ECFDF5'" onmouseout="this.style.background='white'">âœ“ é–‰ã˜ã‚‹</button>
          <button style="flex:1.6;padding:11px;border-radius:10px;font-size:12.5px;font-weight:700;color:white;border:none;cursor:pointer;font-family:inherit;background:linear-gradient(135deg,#059669,#10B981);box-shadow:0 3px 14px rgba(5,150,105,0.35);display:flex;align-items:center;justify-content:center;gap:6px;">
            <svg width="13" height="13" fill="white" viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
            Databricks ã§é–‹ã â†’
          </button>
        </div>
      </div>
    </div>`;
}
</script>
</body>
</html>
